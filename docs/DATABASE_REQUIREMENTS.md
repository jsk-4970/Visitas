# Visitas ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹è¦ä»¶å®šç¾©æ›¸
**åœ¨å®…åŒ»ç™‚ç‰¹åŒ–å‹AIãƒ—ãƒ©ãƒƒãƒˆãƒ•ã‚©ãƒ¼ãƒ ã«ãŠã‘ã‚‹æ‚£è€…ãƒ‡ãƒ¼ã‚¿ç®¡ç†ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£**

---

## ã‚¨ã‚°ã‚¼ã‚¯ãƒ†ã‚£ãƒ–ã‚µãƒãƒªãƒ¼

æœ¬æ–‡æ›¸ã¯ã€åœ¨å®…åŒ»ç™‚ãƒ—ãƒ©ãƒƒãƒˆãƒ•ã‚©ãƒ¼ãƒ ã€ŒVisitasã€ã«ãŠã‘ã‚‹ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹è¨­è¨ˆã®å®Œå…¨ä»•æ§˜ã‚’å®šç¾©ã™ã‚‹ã€‚æœ¬è¨­è¨ˆã¯ã€**æ‚£è€…æƒ…å ±ã®ãƒªãƒƒãƒãªç®¡ç†**ã¨**å¤šå±¤é˜²å¾¡å‹ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£**ã®ä¸¡ç«‹ã‚’æœ€å„ªå…ˆèª²é¡Œã¨ã—ã€ä»¥ä¸‹ã®3ã¤ã®è¨­è¨ˆåŸå‰‡ã«åŸºã¥ãï¼š

1. **SOAPä¸»å°å‹ãƒã‚¤ãƒ–ãƒªãƒƒãƒ‰ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£**: åŒ»ç™‚è¨˜éŒ²ã®æ¨™æº–ãƒ•ãƒ¬ãƒ¼ãƒ ãƒ¯ãƒ¼ã‚¯ï¼ˆSubjective/Objective/Assessment/Planï¼‰ã«æ²¿ã£ã¦ã€ãƒªãƒ¬ãƒ¼ã‚·ãƒ§ãƒŠãƒ«ãƒ‡ãƒ¼ã‚¿ç®¡ç†ã¨JSONBå‹ã«ã‚ˆã‚‹æŸ”è»Ÿæ€§ã‚’æˆ¦ç•¥çš„ã«ä½¿ã„åˆ†ã‘
2. **3çœ2ã‚¬ã‚¤ãƒ‰ãƒ©ã‚¤ãƒ³æº–æ‹ ã®ã‚¼ãƒ­ãƒˆãƒ©ã‚¹ãƒˆã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£**: æš—å·åŒ–ã€ç›£æŸ»ãƒ­ã‚°ã€ã‚¢ã‚¯ã‚»ã‚¹åˆ¶å¾¡ã®å¤šå±¤é˜²å¾¡ã«ã‚ˆã‚‹åŒ»ç™‚æƒ…å ±ä¿è­·
3. **AIé§†å‹•å‹ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼æœ€é©åŒ–**: Gemini/Vertex AIãŠã‚ˆã³Google Maps Route Optimization APIã¨ã®ã‚·ãƒ¼ãƒ ãƒ¬ã‚¹ãªçµ±åˆ

---

## ç›®æ¬¡

1. [æŠ€è¡“åŸºç›¤ã¨é¸å®šæ ¹æ‹ ](#1-æŠ€è¡“åŸºç›¤ã¨é¸å®šæ ¹æ‹ )
2. [ãƒ‡ãƒ¼ã‚¿åˆ†é¡ã¨ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒ¬ãƒ™ãƒ«å®šç¾©](#2-ãƒ‡ãƒ¼ã‚¿åˆ†é¡ã¨ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒ¬ãƒ™ãƒ«å®šç¾©)
3. [ã‚³ã‚¢ãƒ†ãƒ¼ãƒ–ãƒ«è¨­è¨ˆ](#3-ã‚³ã‚¢ãƒ†ãƒ¼ãƒ–ãƒ«è¨­è¨ˆ)
4. [Subjective (S) ãƒ‰ãƒ¡ã‚¤ãƒ³: ç¤¾ä¼šçš„èƒŒæ™¯ã¨ãƒŠãƒ©ãƒ†ã‚£ãƒ–](#4-subjective-s-ãƒ‰ãƒ¡ã‚¤ãƒ³-ç¤¾ä¼šçš„èƒŒæ™¯ã¨ãƒŠãƒ©ãƒ†ã‚£ãƒ–)
5. [Objective (O) ãƒ‰ãƒ¡ã‚¤ãƒ³: åŸºæœ¬æƒ…å ±ãƒ»ä¿é™ºãƒ»åŒ»å­¦çš„ãƒ‡ãƒ¼ã‚¿](#5-objective-o-ãƒ‰ãƒ¡ã‚¤ãƒ³-åŸºæœ¬æƒ…å ±ä¿é™ºåŒ»å­¦çš„ãƒ‡ãƒ¼ã‚¿)
6. [Assessment (A) & Plan (P) ãƒ‰ãƒ¡ã‚¤ãƒ³: è©•ä¾¡ãƒ»è¨ˆç”»ãƒ»ACP](#6-assessment-a--plan-p-ãƒ‰ãƒ¡ã‚¤ãƒ³-è©•ä¾¡è¨ˆç”»acp)
7. [è¨ªå•ãƒ­ã‚¸ã‚¹ãƒ†ã‚£ã‚¯ã‚¹ã¨Route Optimizationçµ±åˆ](#7-è¨ªå•ãƒ­ã‚¸ã‚¹ãƒ†ã‚£ã‚¯ã‚¹ã¨route-optimizationçµ±åˆ)
8. [Firestore: ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ ã‚³ãƒ©ãƒœãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³å±¤](#8-firestore-ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ ã‚³ãƒ©ãƒœãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³å±¤)
9. [ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£å®Ÿè£…è¦ä»¶](#9-ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£å®Ÿè£…è¦ä»¶)
10. [é‹ç”¨ãƒ»ç›£æŸ»ãƒ»ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—æˆ¦ç•¥](#10-é‹ç”¨ç›£æŸ»ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—æˆ¦ç•¥)
11. [ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹æœ€é©åŒ–æˆ¦ç•¥](#11-ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹æœ€é©åŒ–æˆ¦ç•¥)
12. [ç§»è¡Œãƒ»æ‹¡å¼µãƒ»ç½å®³å¾©æ—§](#12-ç§»è¡Œæ‹¡å¼µç½å®³å¾©æ—§)

---

## 1. æŠ€è¡“åŸºç›¤ã¨é¸å®šæ ¹æ‹ 

### 1.1 ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹æŠ€è¡“ã‚¹ã‚¿ãƒƒã‚¯

| ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆ | æŠ€è¡“ | æ¡ç”¨ç†ç”± | ç”¨é€” |
|---|---|---|---|
| **ãƒ¡ã‚¤ãƒ³ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹** | **Cloud Spanner (PostgreSQL Interface)** | å¼·æ•´åˆæ€§(External Consistency)ã€æ°´å¹³ã‚¹ã‚±ãƒ¼ãƒ©ãƒ“ãƒªãƒ†ã‚£ã€99.999%å¯ç”¨æ€§ã€JSONBå‹ã‚µãƒãƒ¼ãƒˆ | æ‚£è€…ãƒã‚¹ã‚¿ãƒ¼ã€åŒ»ç™‚è¨˜éŒ²(SOAP)ã€ä¿é™ºæƒ…å ±ã€ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«ã€è¨ªå•å±¥æ­´ |
| **ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ DB** | **Firestore** | ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ åŒæœŸã€ã‚ªãƒ•ãƒ©ã‚¤ãƒ³å¯¾å¿œã€ãƒ¢ãƒã‚¤ãƒ«æœ€é©åŒ– | ãƒãƒ£ãƒƒãƒˆã€ä½ç½®æƒ…å ±å…±æœ‰ã€é€šçŸ¥ã€åœ¨åº«ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ |
| **èªè¨¼åŸºç›¤** | **Firebase Authentication + Identity Platform** | å¤šè¦ç´ èªè¨¼ã€ç›£æŸ»ãƒ­ã‚°ã€ä¼æ¥­å‘ã‘æ©Ÿèƒ½(SAML/OIDC) | åŒ»ç™‚å¾“äº‹è€…/æ‚£è€…/å®¶æ—ã®èªè¨¼ãƒ»èªå¯ |
| **æš—å·åŒ–ç®¡ç†** | **Cloud KMS (C
MEK)** | æš—å·éµã®ãƒ©ã‚¤ãƒ•ã‚µã‚¤ã‚¯ãƒ«ç®¡ç†ã€HSMä¿è­· | ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹æš—å·åŒ–ã€å€‹äººæƒ…å ±ãƒã‚¹ã‚­ãƒ³ã‚° |
| **ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸** | **Cloud Storage** | ãƒ©ã‚¤ãƒ•ã‚µã‚¤ã‚¯ãƒ«ãƒãƒªã‚·ãƒ¼ã€ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆãƒãƒ¼ã‚¸ãƒ§ãƒ‹ãƒ³ã‚° | éŸ³å£°ãƒ‡ãƒ¼ã‚¿ã€ç”»åƒ(è¤¥ç˜¡å†™çœŸ)ã€PDF(åŒæ„æ›¸) |

### 1.2 Spanner PostgreSQLã‚¤ãƒ³ã‚¿ãƒ¼ãƒ•ã‚§ãƒ¼ã‚¹æ¡ç”¨ã®æŠ€è¡“çš„æ ¹æ‹ 

**å¾“æ¥ã®Spanner Google SQLæ–¹è¨€ã¨ã®æ¯”è¼ƒ:**

| è©•ä¾¡è»¸ | PostgreSQL Interface | Google SQLæ–¹è¨€ | åˆ¤å®š |
|---|---|---|---|
| **JSONBå‹ã‚µãƒãƒ¼ãƒˆ** | âœ… RFC 7159æº–æ‹ ã€è±Šå¯Œãªæ¼”ç®—å­(`@>`, `?`, `#>`) | âŒ JSONå‹ã®ã¿(æ–‡å­—åˆ—æ‰±ã„) | **PG** |
| **ã‚¨ã‚³ã‚·ã‚¹ãƒ†ãƒ ** | è±Šå¯Œãªãƒ„ãƒ¼ãƒ«(pgAdmin, Liquibase, TypeORMå¯¾å¿œ) | é™å®šçš„ | **PG** |
| **å­¦ç¿’ã‚³ã‚¹ãƒˆ** | æ—¢å­˜PostgreSQLã‚¹ã‚­ãƒ«æ´»ç”¨å¯ | ç‹¬è‡ªå­¦ç¿’å¿…è¦ | **PG** |
| **ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹** | åŒç­‰(Spannerã‚¨ãƒ³ã‚¸ãƒ³å…±é€š) | åŒç­‰ | å¼•ãåˆ†ã‘ |
| **æ–°æ©Ÿèƒ½å¯¾å¿œé€Ÿåº¦** | Googleã®é–‹ç™ºæ³¨åŠ›ã‚·ãƒ•ãƒˆ | ãƒ¡ãƒ³ãƒ†ãƒŠãƒ³ã‚¹ãƒ¢ãƒ¼ãƒ‰ | **PG** |

**Spannerã®æ ¸å¿ƒçš„å„ªä½æ€§:**
- **TrueTime API**: GPS/åŸå­æ™‚è¨ˆãƒ™ãƒ¼ã‚¹ã®å¤–éƒ¨æ•´åˆæ€§ã«ã‚ˆã‚Šã€åœ°ç†çš„ã«åˆ†æ•£ã—ãŸè¨ªå•çœ‹è­·ã‚¹ãƒ†ãƒ¼ã‚·ãƒ§ãƒ³é–“ã§ã‚‚ãƒ‡ãƒ¼ã‚¿ã®å› æœé–¢ä¿‚ã‚’å³å¯†ã«ä¿è¨¼
- **ã‚¤ãƒ³ã‚¿ãƒ¼ãƒªãƒ¼ãƒ–ãƒ†ãƒ¼ãƒ–ãƒ«**: è¦ªå­é–¢ä¿‚ã®ãƒ‡ãƒ¼ã‚¿(æ‚£è€…â†’è¨ªå•è¨˜éŒ²â†’ãƒã‚¤ã‚¿ãƒ«ã‚µã‚¤ãƒ³)ã‚’ç‰©ç†çš„ã«éš£æ¥é…ç½®ã—ã€JOINã‚³ã‚¹ãƒˆã‚’æœ€å°åŒ–
- **ãƒ›ãƒƒãƒˆã‚¹ãƒãƒƒãƒˆè‡ªå‹•åˆ†æ•£**: ç‰¹å®šæ‚£è€…ã¸ã®é›†ä¸­ã‚¢ã‚¯ã‚»ã‚¹(ä¾‹:æ•‘æ€¥æ¬é€æ™‚)ã§ã‚‚ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹åŠ£åŒ–ãªã—

### 1.3 FHIR (HL7 Fast Healthcare Interoperability Resources) ã¨ã®é–¢ä¿‚

æœ¬ã‚·ã‚¹ãƒ†ãƒ ã¯ã€FHIR R4ã‚’**æ¦‚å¿µãƒ¢ãƒ‡ãƒ«**ã¨ã—ã¦å‚ç…§ã—ã¤ã¤ã€å®Ÿè£…ä¸Šã¯Spannerã®ç‰¹æ€§ã«æœ€é©åŒ–ã—ãŸç‹¬è‡ªã‚¹ã‚­ãƒ¼ãƒã‚’æ¡ç”¨ã™ã‚‹ã€‚

**FHIRæº–æ‹ æ–¹é‡:**

```
FHIR Resource â†’ Spannerå®Ÿè£…ãƒãƒƒãƒ”ãƒ³ã‚°

Patient â†’ patients ãƒ†ãƒ¼ãƒ–ãƒ«(åŸºæœ¬å±æ€§) + patient_social_profiles (Extension)
Observation â†’ clinical_observations (ãƒã‚¤ã‚¿ãƒ«ã€ADLè©•ä¾¡)
MedicationRequest â†’ medication_orders (JSONBå†…ã«FHIR DosageInstructionã‚’æ ¼ç´)
CarePlan â†’ care_plans + acp_records (JSONBå†…ã«FHIR Goal/Activityãƒãƒƒãƒ”ãƒ³ã‚°)
Coverage â†’ patient_coverages (æ—¥æœ¬ã®ä¿é™ºåˆ¶åº¦æ‹¡å¼µã¨ã—ã¦JSONBæ´»ç”¨)
```

**FHIR Cloud Healthcare APIé€£æº(Phase 3æƒ³å®š):**
- ãƒ‡ãƒ¼ã‚¿ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆæ™‚ã«Spannerã‚¹ã‚­ãƒ¼ãƒâ†’FHIR JSONå¤‰æ›ãƒ¬ã‚¤ãƒ¤ãƒ¼ã‚’å®Ÿè£…
- ä»–åŒ»ç™‚æ©Ÿé–¢é€£æºæ™‚ã®ã¿Cloud Healthcare APIã‚’çµŒç”±ã—ã€FHIR Bundleå½¢å¼ã§é€å—ä¿¡

---

## 2. ãƒ‡ãƒ¼ã‚¿åˆ†é¡ã¨ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒ¬ãƒ™ãƒ«å®šç¾©

### 2.1 3çœ2ã‚¬ã‚¤ãƒ‰ãƒ©ã‚¤ãƒ³æº–æ‹ ã®æƒ…å ±åˆ†é¡

åšç”ŸåŠ´åƒçœã€ŒåŒ»ç™‚æƒ…å ±ã‚·ã‚¹ãƒ†ãƒ ã®å®‰å…¨ç®¡ç†ã«é–¢ã™ã‚‹ã‚¬ã‚¤ãƒ‰ãƒ©ã‚¤ãƒ³ ç¬¬6.0ç‰ˆã€ã«åŸºã¥ãåˆ†é¡:

| ãƒ¬ãƒ™ãƒ« | ãƒ‡ãƒ¼ã‚¿åˆ†é¡ | å…·ä½“ä¾‹ | æš—å·åŒ–è¦ä»¶ | ã‚¢ã‚¯ã‚»ã‚¹åˆ¶é™ |
|---|---|---|---|---|
| **Level 4: æœ€é«˜æ©Ÿå¯†** | åŒ»ç™‚è¨˜éŒ²æœ¬ä½“(è¨ºç™‚éŒ²ã€çœ‹è­·è¨˜éŒ²) | SOAPè¨˜éŒ²ã€æ¤œæŸ»çµæœã€ç—…åã€å‡¦æ–¹ | CMEKæš—å·åŒ–(éµãƒ­ãƒ¼ãƒ†ãƒ¼ã‚·ãƒ§ãƒ³90æ—¥) + ã‚«ãƒ©ãƒ ãƒ¬ãƒ™ãƒ«æš—å·åŒ– | åŒ»ç™‚è·ç¨®+æ‚£è€…æœ¬äººã®ã¿ã€‚ç›£æŸ»ãƒ­ã‚°å¿…é ˆ |
| **Level 3: æ©Ÿå¯†** | å€‹äººè­˜åˆ¥æƒ…å ±(PII) | æ°åã€ç”Ÿå¹´æœˆæ—¥ã€ä½æ‰€ã€ä¿é™ºè¨¼ç•ªå· | CMEKæš—å·åŒ– + ãƒã‚¹ã‚­ãƒ³ã‚°ãƒ“ãƒ¥ãƒ¼æä¾› | åŒ»ç™‚è·ç¨®+äº‹å‹™è·ã€‚ã‚¢ã‚¯ã‚»ã‚¹ãƒ­ã‚°è¨˜éŒ² |
| **Level 2: é™å®šå…¬é–‹** | ã‚±ã‚¢è¨ˆç”»ã€ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ« | è¨ªå•äºˆå®šã€æ‹…å½“ã‚¹ã‚¿ãƒƒãƒ•å‰²å½“ | CMEKæš—å·åŒ– | æ‹…å½“ãƒãƒ¼ãƒ å†…å…±æœ‰ã€‚å®¶æ—ã¸ã®éƒ¨åˆ†é–‹ç¤ºå¯ |
| **Level 1: å†…éƒ¨å…¬é–‹** | çµ±è¨ˆãƒ‡ãƒ¼ã‚¿ã€åŒ¿ååŒ–ãƒ‡ãƒ¼ã‚¿ | é›†è¨ˆãƒ¬ãƒãƒ¼ãƒˆã€ç ”ç©¶ç”¨ãƒ‡ãƒ¼ã‚¿ã‚»ãƒƒãƒˆ | æ¨™æº–æš—å·åŒ–(Google-managed keys) | ç ”ç©¶è€…ã€çµŒå–¶é™£ |

### 2.2 å€‹äººæƒ…å ±ä¿è­·æ³•ãƒ»åŒ»ç™‚æ³•å¯¾å¿œ

**è¦ä»¶:**
1. **åˆ©ç”¨ç›®çš„ã®æ˜ç¤º**: `patients` ãƒ†ãƒ¼ãƒ–ãƒ«ã« `consent_records` JSONBåˆ—ã‚’è¿½åŠ ã—ã€åŒæ„å–å¾—å±¥æ­´ã‚’è¨˜éŒ²
2. **é–‹ç¤ºè«‹æ±‚å¯¾å¿œ**: æ‚£è€…æœ¬äººã‹ã‚‰ã®é–‹ç¤ºè«‹æ±‚ã«å¯¾ã—ã€ãƒ“ãƒ¥ãƒ¼çµŒç”±ã§å…¨ãƒ‡ãƒ¼ã‚¿ã‚’PDFå‡ºåŠ›å¯èƒ½ãªè¨­è¨ˆ
3. **ç¬¬ä¸‰è€…æä¾›è¨˜éŒ²**: `data_sharing_logs` ãƒ†ãƒ¼ãƒ–ãƒ«ã§ä»–åŒ»ç™‚æ©Ÿé–¢ã¸ã®ãƒ‡ãƒ¼ã‚¿æä¾›ã‚’è¨˜éŒ²(5å¹´ä¿å­˜)

---

## 3. ã‚³ã‚¢ãƒ†ãƒ¼ãƒ–ãƒ«è¨­è¨ˆ

### 3.1 ãƒ†ãƒ¼ãƒ–ãƒ«æ§‹æˆã®å…¨ä½“åƒ

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚         Root Table: patients                    â”‚  â† ã‚¤ãƒ³ã‚¿ãƒ¼ãƒªãƒ¼ãƒ–ã®èµ·ç‚¹
â”‚  (patient_id, name, birth_date, ...)           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
              â”‚
              â”œâ”€ patient_identifiers (ãƒã‚¤ãƒŠãƒ³ãƒãƒ¼ã€ä¿é™ºè¨¼ç•ªå·ç­‰)
              â”œâ”€ patient_social_profiles (Subjective: ç¤¾ä¼šçš„èƒŒæ™¯)
              â”œâ”€ patient_coverages (Objective: ä¿é™ºæƒ…å ±)
              â”œâ”€ clinical_observations (Objective: ãƒã‚¤ã‚¿ãƒ«ã€ADL)
              â”œâ”€ medical_conditions (Objective: ç—…åã€æ—¢å¾€æ­´)
              â”œâ”€ allergy_intolerances (Objective: ã‚¢ãƒ¬ãƒ«ã‚®ãƒ¼)
              â”œâ”€ care_plans (Plan: ã‚±ã‚¢è¨ˆç”»)
              â”œâ”€ acp_records (Assessment/Plan: ACP)
              â”œâ”€ medication_orders (Plan: å‡¦æ–¹)
              â”œâ”€ visit_schedules (Plan: è¨ªå•ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«)
              â”‚   â””â”€ visit_records (è¨ªå•å®Ÿæ–½è¨˜éŒ²)
              â”‚       â””â”€ soap_notes (SOAPè¨˜éŒ²)
              â”‚           â””â”€ care_interventions (å‡¦ç½®è©³ç´°)
              â””â”€ coordination_messages (å¤šè·ç¨®é€£æº)
```

### 3.2 å‘½åè¦å‰‡ã¨ãƒ‡ãƒ¼ã‚¿å‹æ¨™æº–

| è¦ç´  | è¦å‰‡ | ä¾‹ |
|---|---|---|
| **ãƒ†ãƒ¼ãƒ–ãƒ«å** | è¤‡æ•°å½¢ã‚¹ãƒãƒ¼ã‚¯ã‚±ãƒ¼ã‚¹ | `patients`, `visit_schedules` |
| **ã‚«ãƒ©ãƒ å** | å˜æ•°å½¢ã‚¹ãƒãƒ¼ã‚¯ã‚±ãƒ¼ã‚¹ | `patient_id`, `birth_date` |
| **ä¸»ã‚­ãƒ¼** | `{entity}_id` å½¢å¼ã®UUID v4 | `patient_id varchar(36)` |
| **ã‚¿ã‚¤ãƒ ã‚¹ã‚¿ãƒ³ãƒ—** | `timestamptz` å‹ã€UTCä¿å­˜ | `created_at timestamptz DEFAULT CURRENT_TIMESTAMP` |
| **è«–ç†å‰Šé™¤** | `is_deleted boolean` + `deleted_at timestamptz` | ç‰©ç†å‰Šé™¤ç¦æ­¢(åŒ»ç™‚æ³•æº–æ‹ ) |
| **JSONBå‘½å** | ã‚­ãƒ£ãƒ¡ãƒ«ã‚±ãƒ¼ã‚¹(JavaScriptäº’æ›æ€§) | `{"keyPerson": {"name": "..."}}` |

---

## 4. Subjective (S) ãƒ‰ãƒ¡ã‚¤ãƒ³: ç¤¾ä¼šçš„èƒŒæ™¯ã¨ãƒŠãƒ©ãƒ†ã‚£ãƒ–

### 4.1 è¨­è¨ˆæ€æƒ³

Subjectiveãƒ‡ãƒ¼ã‚¿ã¯æ‚£è€…ã®ã€Œèªã‚Šã€ã‚„ç”Ÿæ´»æ–‡è„ˆã‚’å«ã‚€ãŸã‚ã€**æ§‹é€ ã®å¤‰åŒ–ãŒæœ€ã‚‚æ¿€ã—ã„**é ˜åŸŸã§ã‚ã‚‹ã€‚ã“ã“ã§ã¯ã€FHIR `Observation` (Social History) ãŠã‚ˆã³SDOH (Social Determinants of Health) æ‹¡å¼µã®æ¦‚å¿µã‚’æ¡ç”¨ã—ã€JSONBã«ã‚ˆã‚‹æŸ”è»Ÿãªã‚¹ã‚­ãƒ¼ãƒã‚’å®Ÿç¾ã™ã‚‹ã€‚

**é‡è¦åŸå‰‡:**
- å›ºå®šã‚¹ã‚­ãƒ¼ãƒã§ã¯è¡¨ç¾å›°é›£ãªã€Œå®¶æ—é–¢ä¿‚ã®æ©Ÿå¾®ã€ã€ŒçµŒæ¸ˆçš„ä¸å®‰ã€ã€Œå®—æ•™çš„é…æ…®ã€ç­‰ã‚’æ§‹é€ åŒ–
- æ¤œç´¢å¯èƒ½æ€§ã‚’æ‹…ä¿ã™ã‚‹ãŸã‚ã€é »å‡ºãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã¯Generated Columnã§å®Ÿä½“åŒ–

### 4.2 ãƒ†ãƒ¼ãƒ–ãƒ«: `patient_social_profiles`

```sql
CREATE TABLE patient_social_profiles (
    profile_id varchar(36) NOT NULL,
    patient_id varchar(36) NOT NULL,
    recorded_at timestamptz NOT NULL DEFAULT CURRENT_TIMESTAMP,
    author_id varchar(36) NOT NULL, -- è¨˜éŒ²è€…(çœ‹è­·å¸«/MSW)
    profile_version int NOT NULL DEFAULT 1, -- å¤‰æ›´å±¥æ­´ç®¡ç†
    content jsonb NOT NULL, -- ç¤¾ä¼šçš„èƒŒæ™¯ã®æœ¬ä½“

    -- Generated Columns (æ¤œç´¢é«˜é€ŸåŒ–ç”¨)
    living_status text GENERATED ALWAYS AS (content->'livingSituation'->>'status') STORED,
    primary_caregiver_name text GENERATED ALWAYS AS (content->'keyPersons'->0->>'name') STORED,
    has_financial_concerns boolean GENERATED ALWAYS AS (content->'financialBackground' ? 'concerns') STORED,

    -- ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒ»ç›£æŸ»
    data_sensitivity varchar(20) NOT NULL DEFAULT 'confidential',
    last_accessed_at timestamptz,
    last_accessed_by varchar(36),

    PRIMARY KEY (patient_id, profile_id),
    CONSTRAINT fk_patient FOREIGN KEY (patient_id) REFERENCES patients(patient_id)
) INTERLEAVE IN PARENT patients ON DELETE CASCADE;

-- ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹: ç‹¬å±…é«˜é½¢è€…ã®æŠ½å‡ºç­‰ã«ä½¿ç”¨
CREATE INDEX idx_living_status ON patient_social_profiles(living_status);
CREATE INDEX idx_financial_concerns ON patient_social_profiles(has_financial_concerns)
    WHERE has_financial_concerns = true;
```

### 4.3 JSONBæ§‹é€ : `content` ã‚«ãƒ©ãƒ è©³ç´°ä»•æ§˜

```json
{
  "livingSituation": {
    "status": "living_alone",  // ç‹¬å±… | living_with_family | facility
    "statusDisplay": "ç‹¬å±…",
    "description": "é•·ç”·ã¯çœŒå¤–åœ¨ä½ã€‚é€±1å›é›»è©±é€£çµ¡ã‚ã‚Šã€‚",
    "lastUpdated": "2025-12-01",
    "environment": {
      "housingType": "detached_house",  // æˆ¸å»ºã¦ | apartment | group_home
      "floor": 2,
      "hasElevator": false,
      "barrierFree": false,
      "stairs": {
        "steps": 15,
        "handrail": "right_side",
        "steepness": "steep"
      },
      "entryAccess": {
        "hasAutoLock": true,
        "unlockMethod": "key_box",
        "keyBoxLocation": "ã‚¬ã‚¹ãƒ¡ãƒ¼ã‚¿ãƒ¼å†…",
        "unlockCode": "**ENCRYPTED**",  // ã‚¢ãƒ—ãƒªå±¤ã§æš—å·åŒ–ã—ãŸå€¤ã‚’æ ¼ç´
        "specialInstructions": "ç„é–¢ã®å‘¼ã³éˆ´ã¯èã“ãˆã«ãã„ã€‚æºå¸¯ã«ç›´æ¥é€£çµ¡ã‚’æ¨å¥¨"
      },
      "hazards": ["æ®µå·®ã‚ã‚Š", "ç…§æ˜æš—ã„", "çŒ«2åŒ¹é£¼è‚²ä¸­"],
      "pets": [
        {"type": "cat", "name": "ãŸã¾", "allergyRisk": false}
      ]
    }
  },

  "keyPersons": [
    {
      "id": "kp-001",
      "name": "å±±ç”° èŠ±å­",
      "relationship": "spouse",  // FHIR RelatedPersonæº–æ‹ 
      "relationshipDisplay": "é…å¶è€…",
      "priority": 1,  // ç·Šæ€¥é€£çµ¡é †ä½
      "role": "primary_caregiver",  // ä¸»ä»‹è­·è€… | decision_maker | emergency_contact
      "contactPoints": [
        {
          "system": "phone",
          "value": "090-1234-5678",
          "use": "mobile",
          "rank": 1
        },
        {
          "system": "email",
          "value": "hanako@example.com",
          "use": "home"
        }
      ],
      "address": {
        "use": "home",
        "postalCode": "123-4567",
        "prefecture": "æ±äº¬éƒ½",
        "city": "æ–°å®¿åŒº",
        "line": "è¥¿æ–°å®¿1-2-3",
        "geolocation": {"lat": 35.6895, "lng": 139.6917}
      },
      "availability": {
        "weekdayDaytime": "available",  // å¹³æ—¥æ—¥ä¸­å¯¾å¿œå¯
        "weekdayNight": "limited",
        "weekend": "available",
        "notes": "ç«æ›œåˆå¾Œã¯ãƒ‘ãƒ¼ãƒˆå‹¤å‹™ã§ä¸åœ¨"
      },
      "caregiverBurden": {
        "zaritScore": 45,  // Zaritä»‹è­·è² æ‹…å°ºåº¦
        "burnoutRisk": "moderate",
        "lastAssessed": "2025-11-15",
        "respiteNeeds": {
          "desired": true,
          "frequency": "é€±1å›",
          "preferredService": "ã‚·ãƒ§ãƒ¼ãƒˆã‚¹ãƒ†ã‚¤"
        },
        "healthConcerns": "è…°ç—›ã‚ã‚Šã€‚æ•´å½¢å¤–ç§‘é€šé™¢ä¸­ã€‚",
        "sleepQuality": "poor",  // ç¡çœ éšœå®³ã®æœ‰ç„¡
        "mentalHealth": {
          "anxiety": "moderate",
          "depression": "mild",
          "supportServices": ["åœ°åŸŸåŒ…æ‹¬æ”¯æ´ã‚»ãƒ³ã‚¿ãƒ¼ç›¸è«‡æ­´ã‚ã‚Š"]
        }
      },
      "decisionMakingAuthority": "full",  // å®Œå…¨ãªæ„æ€æ±ºå®šæ¨©é™ | partial | none
      "advanceDirectiveProxy": true  // æœ¬äººã®æ„æ€æ±ºå®šä»£ç†äººã‹
    }
  ],

  "emergencyContacts": [
    {
      "name": "å±±ç”° å¤ªéƒ",
      "relationship": "son",
      "phone": "080-9876-5432",
      "priority": 2,
      "notificationConditions": ["æœ¬äººé€£çµ¡ä¸èƒ½æ™‚", "é‡å¤§ãªç—…çŠ¶å¤‰åŒ–"]
    }
  ],

  "socialHistory": {
    "occupation": {
      "current": "retired",
      "past": [
        {"job": "é«˜æ ¡æ•™å¸«", "years": "1970-2010"}
      ]
    },
    "lifestyle": {
      "smoking": {
        "status": "former_smoker",  // LOINC 72166-2æº–æ‹ 
        "packsPerDay": 1,
        "yearsSmoked": 40,
        "quitDate": "2010-03-01",
        "quitReason": "åŒ»å¸«å‹§å‘Š"
      },
      "alcohol": {
        "status": "never",  // LOINC 74013-4æº–æ‹ 
        "frequency": "none"
      },
      "diet": {
        "restrictions": ["æ¸›å¡©é£Ÿ", "ç³–è³ªåˆ¶é™"],
        "preferences": ["å’Œé£Ÿå¥½ã", "é­šä¸­å¿ƒ"],
        "challenges": "é£Ÿæ¬²ä½ä¸‹å‚¾å‘"
      },
      "exercise": {
        "frequency": "é€±3å›",
        "type": "è¿‘æ‰€ã‚’æ•£æ­©",
        "duration": "30åˆ†",
        "limitations": "è†ç—›ã«ã‚ˆã‚Šé•·è·é›¢ã¯å›°é›£"
      }
    },
    "hobbies": ["åœ’èŠ¸", "ä¿³å¥", "å­«ã¨ã®é›»è©±"],
    "importantValues": "å®¶æ—ã«è¿·æƒ‘ã‚’ã‹ã‘ãŸããªã„ã€‚è‡ªå®…ã§æœ€æœŸã‚’è¿ãˆãŸã„ã€‚"
  },

  "religiousCulturalNeeds": {
    "religion": "ä»æ•™",
    "sect": "æµ„åœŸçœŸå®—",
    "practicesAffectingCare": [
      "æœå¤•ã®ãŠå‹¤ã‚æ™‚é–“å¸¯(7:00, 18:00)ã®è¨ªå•ã¯é¿ã‘ã¦ã»ã—ã„"
    ],
    "endOfLifePreferences": {
      "rituals": "æ•çµŒã‚’å¸Œæœ›",
      "contactPerson": "è©æå¯ºä½è·(é€£çµ¡å…ˆ: xxx-xxxx)"
    }
  },

  "financialBackground": {
    "economicStatus": "pension_only",
    "monthlyIncome": "å¹´é‡‘12ä¸‡å††",
    "publicAssistance": false,
    "concerns": "åŒ»ç™‚è²»ãƒ»ä»‹è­·è²»ã®æ”¯æ‰•ã„ã«ä¸å®‰ã€‚é«˜é¡ç™‚é¤Šè²»åˆ¶åº¦ã®èª¬æ˜ã‚’å®Ÿæ–½æ¸ˆã¿ã€‚",
    "insuranceCoverage": {
      "lifeInsurance": false,
      "supplementalCareInsurance": false
    }
  },

  "cognitiveStatus": {
    "impairmentLevel": "mild",  // ãªã— | mild | moderate | severe
    "mmseScore": 24,
    "lastAssessed": "2025-11-20",
    "decisionMakingCapacity": "retained_with_support",
    "communicationAbility": {
      "verbal": "clear",
      "comprehension": "good_with_repetition",
      "preferredLanguage": "æ—¥æœ¬èª",
      "hearingAid": true,
      "visualAid": "reading_glasses"
    }
  },

  "safetyRisks": {
    "fallRisk": "high",  // Morse Fall Scale
    "wanderingRisk": false,
    "selfNeglect": false,
    "abuseOrNeglect": {
      "suspected": false,
      "assessedBy": "nurse-456",
      "assessmentDate": "2025-10-01"
    },
    "environmentalHazards": ["æ®µå·®", "ç…§æ˜ä¸è¶³"]
  }
}
```

**ENCRYPTED**ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã®å®Ÿè£…:**
- ã‚ªãƒ¼ãƒˆãƒ­ãƒƒã‚¯è§£é™¤ã‚³ãƒ¼ãƒ‰ç­‰ã®æ©Ÿå¾®æƒ…å ±ã¯ã€Cloud KMSã§ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³å±¤æš—å·åŒ–(AEAD)ã—ã¦ã‹ã‚‰JSONBæ ¼ç´
- å¾©å·ã¯ã‚¢ã‚¯ã‚»ã‚¹åˆ¶å¾¡ã‚’é€šéã—ãŸè¨ªå•ã‚¹ã‚¿ãƒƒãƒ•ã®ã¿å®Ÿè¡Œå¯èƒ½
- ç›£æŸ»ãƒ­ã‚°ã«å¾©å·ãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’è¨˜éŒ²(Decrypt API Call Logging)

### 4.4 ä»‹è­·è€…è² æ‹…è©•ä¾¡(Caregiver Burden Assessment)ã®é‡è¦æ€§

**åœ¨å®…åŒ»ç™‚ã«ãŠã‘ã‚‹ã€Œéš ã‚ŒãŸæ‚£è€…ã€ã¨ã—ã¦ã®ä»‹è­·è€…:**

Visitasã¯ã€æ‚£è€…ã ã‘ã§ãªã**ä»‹è­·è€…ã®å¥åº·ã¨ã‚¦ã‚§ãƒ«ãƒ“ãƒ¼ã‚¤ãƒ³ã‚°**ã‚‚ãƒ‡ãƒ¼ã‚¿ã¨ã—ã¦è¨˜éŒ²ãƒ»è©•ä¾¡ã™ã‚‹ã€‚ä»‹è­·è€…ã®ç‡ƒãˆå°½ã(Burnout)ã¯ã€åœ¨å®…åŒ»ç™‚ã®ç¶™ç¶šå¯èƒ½æ€§ã‚’å·¦å³ã™ã‚‹æœ€å¤§ã®ãƒªã‚¹ã‚¯è¦å› ã§ã‚ã‚‹ã€‚

**ãƒ‡ãƒ¼ã‚¿æ´»ç”¨ã‚·ãƒŠãƒªã‚ª:**
1. **ãƒ¬ã‚¹ãƒ‘ã‚¤ãƒˆã‚±ã‚¢ã®è‡ªå‹•ææ¡ˆ**: Zarit ScoreãŒ48ä»¥ä¸Š(é«˜è² æ‹…)ã®ä»‹è­·è€…ã«å¯¾ã—ã€ã‚·ãƒ§ãƒ¼ãƒˆã‚¹ãƒ†ã‚¤ç©ºãæƒ…å ±ã‚’è‡ªå‹•é€šçŸ¥
2. **è¨ªå•é »åº¦ã®èª¿æ•´**: ä»‹è­·è€…ã®å¥åº·æ‚ªåŒ–æ™‚ã¯è¨ªå•çœ‹è­·é »åº¦ã‚’å¢—åŠ 
3. **å¤šè·ç¨®ã‚«ãƒ³ãƒ•ã‚¡ãƒ¬ãƒ³ã‚¹**: åŒ»ç™‚ã‚½ãƒ¼ã‚·ãƒ£ãƒ«ãƒ¯ãƒ¼ã‚«ãƒ¼(MSW)ã¸è‡ªå‹•ã‚¢ãƒ©ãƒ¼ãƒˆé€ä¿¡

---

## 5. Objective (O) ãƒ‰ãƒ¡ã‚¤ãƒ³: åŸºæœ¬æƒ…å ±ãƒ»ä¿é™ºãƒ»åŒ»å­¦çš„ãƒ‡ãƒ¼ã‚¿

### 5.1 ãƒ†ãƒ¼ãƒ–ãƒ«: `patients` (Root Table)

**è¨­è¨ˆåŸå‰‡:**
- æœ€å°é™ã®ä¸å¤‰æƒ…å ±ã®ã¿ã‚«ãƒ©ãƒ åŒ–(patient_id, ç”Ÿå¹´æœˆæ—¥ç­‰)
- å¤‰æ›´å¯èƒ½ãªå±æ€§(ä½æ‰€ã€é€£çµ¡å…ˆ)ã¯JSONBåŒ–ã—ã€å±¥æ­´ç®¡ç†ã‚’å®Ÿç¾

```sql
CREATE TABLE patients (
    patient_id varchar(36) NOT NULL,

    -- åŸºæœ¬è­˜åˆ¥æƒ…å ±(ä¸å¤‰)
    birth_date date NOT NULL,
    gender varchar(20) NOT NULL,  -- FHIR AdministrativeGender: male | female | other | unknown
    blood_type varchar(5),  -- A | B | O | AB + Rh

    -- æ°å(å¤‰æ›´å¯èƒ½æ€§ã‚’è€ƒæ…®ã—ã¦JSONB)
    name jsonb NOT NULL,  -- {"family": "å±±ç”°", "given": "å¤ªéƒ", "kana": "ãƒ¤ãƒãƒ€ ã‚¿ãƒ­ã‚¦"}

    -- é€£çµ¡å…ˆãƒ»ä½æ‰€(å±¥æ­´ç®¡ç†ã®ãŸã‚JSONBé…åˆ—)
    contact_points jsonb,  -- [{"system": "phone", "value": "...", "period": {"start": "2025-01-01"}}]
    addresses jsonb,  -- è¤‡æ•°ä½æ‰€å¯¾å¿œ(è‡ªå®…ã€æ–½è¨­ã€å¸°çœå…ˆç­‰)

    -- å†™çœŸ(æœ¬äººç¢ºèªç”¨)
    photo_url text,  -- Cloud Storage URI

    -- ã‚·ã‚¹ãƒ†ãƒ ç®¡ç†
    active boolean NOT NULL DEFAULT true,
    is_deleted boolean NOT NULL DEFAULT false,
    deleted_at timestamptz,
    created_at timestamptz NOT NULL DEFAULT CURRENT_TIMESTAMP,
    updated_at timestamptz NOT NULL DEFAULT CURRENT_TIMESTAMP,

    -- åŒæ„ç®¡ç†
    consent_records jsonb,  -- å€‹äººæƒ…å ±å–æ‰±åŒæ„ã€ç ”ç©¶åˆ©ç”¨åŒæ„ç­‰

    -- ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£
    data_classification varchar(20) NOT NULL DEFAULT 'confidential',
    encryption_key_version int NOT NULL DEFAULT 1,

    PRIMARY KEY (patient_id)
);

-- Generated Columns for æ¤œç´¢
ALTER TABLE patients
ADD COLUMN full_name text GENERATED ALWAYS AS (
    name->>'family' || ' ' || name->>'given'
) STORED;

ALTER TABLE patients
ADD COLUMN full_name_kana text GENERATED ALWAYS AS (name->>'kana') STORED;

ALTER TABLE patients
ADD COLUMN primary_phone text GENERATED ALWAYS AS (
    contact_points->0->>'value'
) STORED;

-- Indexes
CREATE INDEX idx_patient_name_kana ON patients(full_name_kana);
CREATE INDEX idx_patient_birth_date ON patients(birth_date);
CREATE INDEX idx_patient_active ON patients(active) WHERE active = true;
```

**`name` JSONBæ§‹é€ :**
```json
{
  "use": "official",
  "family": "å±±ç”°",
  "given": "å¤ªéƒ",
  "kana": "ãƒ¤ãƒãƒ€ ã‚¿ãƒ­ã‚¦",
  "previousNames": [
    {"family": "ä½è—¤", "given": "å¤ªéƒ", "period": {"end": "2020-05-01"}, "changeReason": "å©šå§»"}
  ]
}
```

### 5.2 ãƒ†ãƒ¼ãƒ–ãƒ«: `patient_identifiers` (è¤‡æ•°IDç®¡ç†)

æ‚£è€…ã¯è¤‡æ•°ã®è­˜åˆ¥å­(ãƒã‚¤ãƒŠãƒ³ãƒãƒ¼ã€ä¿é™ºè¨¼ç•ªå·ã€æ‚£è€…IDç­‰)ã‚’æŒã¤ãŸã‚ã€FHIRã®`Identifier`ãƒ‘ã‚¿ãƒ¼ãƒ³ã«å¾“ã„åˆ†é›¢ãƒ†ãƒ¼ãƒ–ãƒ«ã§ç®¡ç†ã€‚

```sql
CREATE TABLE patient_identifiers (
    identifier_id varchar(36) NOT NULL,
    patient_id varchar(36) NOT NULL,

    system varchar(100) NOT NULL,  -- è­˜åˆ¥å­ä½“ç³»: "urn:oid:jpn-mynumber", "urn:oid:insurance-number"
    value varchar(100) NOT NULL,
    type varchar(50) NOT NULL,  -- "mynumber" | "insurance_number" | "hospital_mrn"

    period_start date,
    period_end date,

    -- ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£: ãƒã‚¤ãƒŠãƒ³ãƒãƒ¼ã¯è¿½åŠ æš—å·åŒ–
    is_encrypted boolean NOT NULL DEFAULT false,

    PRIMARY KEY (patient_id, identifier_id),
    CONSTRAINT fk_patient FOREIGN KEY (patient_id) REFERENCES patients(patient_id),
    CONSTRAINT unique_identifier UNIQUE (system, value)
) INTERLEAVE IN PARENT patients ON DELETE CASCADE;

-- æ¤œç´¢ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹
CREATE INDEX idx_identifier_value ON patient_identifiers(value);
```

### 5.3 ãƒ†ãƒ¼ãƒ–ãƒ«: `patient_coverages` (ä¿é™ºæƒ…å ±)

**æ—¥æœ¬ã®åŒ»ç™‚ãƒ»ä»‹è­·ä¿é™ºåˆ¶åº¦ã®è¤‡é›‘æ€§ã¸ã®å¯¾å¿œ:**

```sql
CREATE TABLE patient_coverages (
    coverage_id varchar(36) NOT NULL,
    patient_id varchar(36) NOT NULL,

    insurance_type varchar(50) NOT NULL,  -- "medical" | "long_term_care" | "public_expense"
    payer_organization varchar(200),  -- ä¿é™ºè€…åç§°

    valid_from date NOT NULL,
    valid_to date,
    status varchar(20) NOT NULL,  -- "active" | "cancelled" | "draft" | "entered-in-error"

    details jsonb NOT NULL,  -- ä¿é™ºè¨¼è©³ç´°ã€è² æ‹…å‰²åˆã€é™åº¦é¡ç­‰

    -- Generated Columns
    care_level int GENERATED ALWAYS AS (
        CASE WHEN insurance_type = 'long_term_care'
        THEN (details->'careLevelCertification'->>'levelCode')::int
        ELSE NULL END
    ) STORED,

    copayment_ratio numeric(3,2) GENERATED ALWAYS AS (
        (details->'copayment'->>'ratio')::numeric
    ) STORED,

    created_at timestamptz NOT NULL DEFAULT CURRENT_TIMESTAMP,
    updated_at timestamptz NOT NULL DEFAULT CURRENT_TIMESTAMP,

    PRIMARY KEY (patient_id, coverage_id),
    CONSTRAINT fk_patient FOREIGN KEY (patient_id) REFERENCES patients(patient_id)
) INTERLEAVE IN PARENT patients ON DELETE CASCADE;

-- æœ‰åŠ¹æœŸé™åˆ‡ã‚Œä¿é™ºè¨¼ã®å®šæœŸæ¤œå‡ºç”¨
CREATE INDEX idx_coverage_expiration ON patient_coverages(valid_to)
    WHERE status = 'active' AND valid_to IS NOT NULL;
```

**`details` JSONBæ§‹é€ (ä»‹è­·ä¿é™ºã®ä¾‹):**

```json
{
  "insuranceType": "long_term_care",
  "insurerNumber": "123456",
  "insuredSymbol": "AB",
  "insuredNumber": "98765432",
  "certificateUrl": "gs://visitas-documents/patient-xxx/care-insurance-cert.pdf",

  "careLevelCertification": {
    "level": "care_level_3",
    "levelCode": 3,
    "levelDisplay": "è¦ä»‹è­·3",
    "certifiedDate": "2025-04-01",
    "validFrom": "2025-04-01",
    "validTo": "2027-03-31",
    "certificationStatus": "certified",
    "certificationAuthority": "æ–°å®¿åŒº",

    "serviceLimits": {
      "maxBenefitUnits": 27048,
      "usedUnitsThisMonth": 18500,
      "remainingUnits": 8548,
      "lastCalculated": "2025-12-01"
    },

    "previousLevels": [
      {
        "level": "care_level_2",
        "period": {"start": "2023-04-01", "end": "2025-03-31"}
      }
    ]
  },

  "copayment": {
    "ratio": 0.1,
    "limitAmount": 15000,
    "limitType": "monthly_cap",
    "reducedCopayment": false
  },

  "serviceRestrictions": {
    "hasRestriction": false,
    "restrictionPeriod": null,
    "reason": null
  },

  "publicExpenseSupplements": [
    {
      "programName": "é«˜é¡ä»‹è­·ã‚µãƒ¼ãƒ“ã‚¹è²»",
      "recipientNumber": "xxx-yyy",
      "validFrom": "2025-01-01"
    }
  ]
}
```

### 5.4 ãƒ†ãƒ¼ãƒ–ãƒ«: `medical_conditions` (ç—…åãƒ»æ—¢å¾€æ­´)

```sql
CREATE TABLE medical_conditions (
    condition_id varchar(36) NOT NULL,
    patient_id varchar(36) NOT NULL,

    clinical_status varchar(20) NOT NULL,  -- "active" | "recurrence" | "relapse" | "inactive" | "remission" | "resolved"
    verification_status varchar(20) NOT NULL,  -- "confirmed" | "provisional" | "differential" | "refuted"

    category varchar(50),  -- "ä¸»ç—…å" | "æ—¢å¾€æ­´" | "åˆä½µç—‡"
    severity varchar(20),  -- "mild" | "moderate" | "severe"

    code jsonb NOT NULL,  -- ICD-10ã‚³ãƒ¼ãƒ‰ã€ç—…åãƒã‚¹ã‚¿ãƒ¼ã‚³ãƒ¼ãƒ‰
    onset_date date,
    abatement_date date,

    notes text,  -- ç—…æ­´è©³ç´°

    recorded_date timestamptz NOT NULL DEFAULT CURRENT_TIMESTAMP,
    recorded_by varchar(36),  -- åŒ»å¸«ID

    PRIMARY KEY (patient_id, condition_id),
    CONSTRAINT fk_patient FOREIGN KEY (patient_id) REFERENCES patients(patient_id)
) INTERLEAVE IN PARENT patients ON DELETE CASCADE;

-- ä¸»ç—…åæ¤œç´¢
CREATE INDEX idx_condition_primary ON medical_conditions(patient_id, category)
    WHERE category = 'ä¸»ç—…å' AND clinical_status = 'active';
```

**`code` JSONB(ICD-10 + ç—…åãƒã‚¹ã‚¿ãƒ¼):**

```json
{
  "coding": [
    {
      "system": "urn:oid:2.16.840.1.113883.6.3",
      "code": "I50.9",
      "display": "å¿ƒä¸å…¨ã€è©³ç´°ä¸æ˜"
    },
    {
      "system": "urn:oid:jpn-disease-master",
      "code": "20059739",
      "display": "æ…¢æ€§å¿ƒä¸å…¨"
    }
  ],
  "text": "æ…¢æ€§å¿ƒä¸å…¨(NYHA class III)"
}
```

### 5.5 ãƒ†ãƒ¼ãƒ–ãƒ«: `allergy_intolerances` (ã‚¢ãƒ¬ãƒ«ã‚®ãƒ¼ãƒ»å‰¯ä½œç”¨æ­´)

**åŒ»ç™‚å®‰å…¨ã®æœ€é‡è¦ãƒ‡ãƒ¼ã‚¿:**

```sql
CREATE TABLE allergy_intolerances (
    allergy_id varchar(36) NOT NULL,
    patient_id varchar(36) NOT NULL,

    clinical_status varchar(20) NOT NULL DEFAULT 'active',  -- "active" | "inactive" | "resolved"
    verification_status varchar(20) NOT NULL,  -- "confirmed" | "unconfirmed" | "refuted"

    type varchar(20) NOT NULL,  -- "allergy" | "intolerance"
    category varchar(20) NOT NULL,  -- "food" | "medication" | "environment" | "biologic"
    criticality varchar(20),  -- "low" | "high" | "unable-to-assess"

    substance jsonb NOT NULL,  -- ã‚¢ãƒ¬ãƒ«ã‚²ãƒ³(è–¬å‰¤åã€é£Ÿç‰©åç­‰)
    reaction jsonb,  -- åå¿œå†…å®¹(ç—‡çŠ¶ã€é‡ç—‡åº¦)

    onset_date date,
    recorded_date timestamptz NOT NULL DEFAULT CURRENT_TIMESTAMP,
    recorded_by varchar(36),

    -- ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£
    alert_level varchar(20) NOT NULL DEFAULT 'warning',  -- å‡¦æ–¹ã‚·ã‚¹ãƒ†ãƒ ã¸ã®ã‚¢ãƒ©ãƒ¼ãƒˆå¼·åº¦

    PRIMARY KEY (patient_id, allergy_id),
    CONSTRAINT fk_patient FOREIGN KEY (patient_id) REFERENCES patients(patient_id)
) INTERLEAVE IN PARENT patients ON DELETE CASCADE;

-- é«˜ãƒªã‚¹ã‚¯ã‚¢ãƒ¬ãƒ«ã‚®ãƒ¼ã®å³æ™‚æ¤œç´¢
CREATE INDEX idx_allergy_critical ON allergy_intolerances(patient_id)
    WHERE criticality = 'high' AND clinical_status = 'active';
```

**`substance` JSONB:**

```json
{
  "coding": [
    {
      "system": "urn:oid:jpn-yj-code",
      "code": "2171022F1",
      "display": "ã‚¢ãƒ¢ã‚­ã‚·ã‚·ãƒªãƒ³"
    }
  ],
  "text": "ãƒšãƒ‹ã‚·ãƒªãƒ³ç³»æŠ—ç”Ÿç‰©è³ª"
}
```

**`reaction` JSONB:**

```json
{
  "manifestations": [
    {
      "code": {"text": "å…¨èº«è•éº»ç–¹"},
      "severity": "moderate"
    },
    {
      "code": {"text": "å‘¼å¸å›°é›£"},
      "severity": "severe"
    }
  ],
  "onset": "30åˆ†ä»¥å†…",
  "exposureRoute": "oral",
  "note": "2020å¹´5æœˆã€æ­¯ç§‘æ²»ç™‚å¾Œã«ç™ºç—‡ã€‚ã‚¨ãƒ”ãƒšãƒ³å‡¦æ–¹æ­´ã‚ã‚Šã€‚"
}
```

### 5.6 ãƒ†ãƒ¼ãƒ–ãƒ«: `clinical_observations` (ãƒã‚¤ã‚¿ãƒ«ã‚µã‚¤ãƒ³ãƒ»ADLè©•ä¾¡)

**æ™‚ç³»åˆ—ãƒ‡ãƒ¼ã‚¿ã®åŠ¹ç‡çš„ç®¡ç†:**

```sql
CREATE TABLE clinical_observations (
    observation_id varchar(36) NOT NULL,
    patient_id varchar(36) NOT NULL,

    category varchar(50) NOT NULL,  -- "vital_signs" | "adl_assessment" | "cognitive_assessment" | "pain_scale"
    code jsonb NOT NULL,  -- LOINC/SNOMED CTæº–æ‹ 

    effective_datetime timestamptz NOT NULL,  -- æ¸¬å®šæ—¥æ™‚
    issued timestamptz NOT NULL DEFAULT CURRENT_TIMESTAMP,  -- è¨˜éŒ²æ—¥æ™‚

    value jsonb NOT NULL,  -- æ¸¬å®šå€¤(æ•°å€¤ã€ã‚³ãƒ¼ãƒ‰å€¤ã€ã‚¹ã‚³ã‚¢ç­‰)
    interpretation varchar(20),  -- "normal" | "high" | "low" | "critical"

    performer_id varchar(36),  -- æ¸¬å®šè€…
    device_id varchar(36),  -- æ¸¬å®šæ©Ÿå™¨ID(IoTé€£æºæƒ³å®š)

    -- å‚ç…§å…ƒè¨ªå•è¨˜éŒ²
    visit_record_id varchar(36),

    PRIMARY KEY (patient_id, observation_id),
    CONSTRAINT fk_patient FOREIGN KEY (patient_id) REFERENCES patients(patient_id)
) INTERLEAVE IN PARENT patients ON DELETE CASCADE;

-- æ™‚ç³»åˆ—ã‚¯ã‚¨ãƒªæœ€é©åŒ–
CREATE INDEX idx_observation_datetime ON clinical_observations(patient_id, effective_datetime DESC);
CREATE INDEX idx_observation_category ON clinical_observations(patient_id, category, effective_datetime DESC);
```

**ãƒã‚¤ã‚¿ãƒ«ã‚µã‚¤ãƒ³ã®JSONBä¾‹:**

```json
{
  "code": {
    "coding": [{"system": "http://loinc.org", "code": "85354-9", "display": "Blood pressure panel"}]
  },
  "value": {
    "systolic": {"value": 135, "unit": "mmHg"},
    "diastolic": {"value": 82, "unit": "mmHg"},
    "heartRate": {"value": 78, "unit": "bpm"},
    "bodyTemperature": {"value": 36.5, "unit": "Cel"},
    "spo2": {"value": 96, "unit": "%"},
    "respiratoryRate": {"value": 18, "unit": "/min"}
  },
  "bodyPosition": "sitting",  // æ¸¬å®šä½“ä½
  "notes": "å·¦ä¸Šè…•ã§æ¸¬å®šã€‚ä¸æ•´è„ˆãªã—ã€‚"
}
```

**ADLè©•ä¾¡(Barthel Index)ã®JSONBä¾‹:**

```json
{
  "code": {
    "coding": [{"system": "http://loinc.org", "code": "89210-8", "display": "Barthel Index"}]
  },
  "value": {
    "method": "Barthel Index",
    "totalScore": 45,
    "maxScore": 100,
    "components": {
      "feeding": {"score": 5, "maxScore": 10, "description": "éƒ¨åˆ†ä»‹åŠ©"},
      "transfer": {"score": 5, "maxScore": 15, "description": "ä¸­ç­‰åº¦ä»‹åŠ©"},
      "grooming": {"score": 0, "maxScore": 5, "description": "å…¨ä»‹åŠ©"},
      "toiletUse": {"score": 5, "maxScore": 10, "description": "éƒ¨åˆ†ä»‹åŠ©"},
      "bathing": {"score": 0, "maxScore": 5, "description": "å…¨ä»‹åŠ©"},
      "mobility": {"score": 5, "maxScore": 15, "description": "è»Šæ¤…å­è‡ªèµ°å¯"},
      "stairs": {"score": 0, "maxScore": 10, "description": "ä¸èƒ½"},
      "dressing": {"score": 5, "maxScore": 10, "description": "éƒ¨åˆ†ä»‹åŠ©"},
      "bowels": {"score": 10, "maxScore": 10, "description": "è‡ªç«‹"},
      "bladder": {"score": 5, "maxScore": 10, "description": "éƒ¨åˆ†ä»‹åŠ©"}
    }
  },
  "assessorComment": "å³éº»ç—ºã«ã‚ˆã‚Šç§»ä¹—å‹•ä½œã«ä»‹åŠ©ã‚’è¦ã™ã‚‹ã€‚ãƒªãƒãƒ“ãƒªã«ã‚ˆã‚Šæ”¹å–„å‚¾å‘ã€‚",
  "previousScore": {"totalScore": 40, "assessedDate": "2025-11-01"},
  "trend": "improving"
}
```

---

## 6. Assessment (A) & Plan (P) ãƒ‰ãƒ¡ã‚¤ãƒ³: è©•ä¾¡ãƒ»è¨ˆç”»ãƒ»ACP

### 6.1 ãƒ†ãƒ¼ãƒ–ãƒ«: `care_plans` (ã‚±ã‚¢è¨ˆç”»)

```sql
CREATE TABLE care_plans (
    plan_id varchar(36) NOT NULL,
    patient_id varchar(36) NOT NULL,

    status varchar(20) NOT NULL,  -- "draft" | "active" | "on-hold" | "revoked" | "completed"
    intent varchar(20) NOT NULL,  -- "proposal" | "plan" | "order"

    title varchar(200) NOT NULL,
    description text,

    period_start date NOT NULL,
    period_end date,

    goals jsonb,  -- ç›®æ¨™(SMARTå½¢å¼)
    activities jsonb,  -- æ´»å‹•è¨ˆç”»

    created_by varchar(36) NOT NULL,
    created_at timestamptz NOT NULL DEFAULT CURRENT_TIMESTAMP,
    updated_at timestamptz NOT NULL DEFAULT CURRENT_TIMESTAMP,

    PRIMARY KEY (patient_id, plan_id),
    CONSTRAINT fk_patient FOREIGN KEY (patient_id) REFERENCES patients(patient_id)
) INTERLEAVE IN PARENT patients ON DELETE CASCADE;

-- ã‚¢ã‚¯ãƒ†ã‚£ãƒ–ãªã‚±ã‚¢è¨ˆç”»ã®å–å¾—
CREATE INDEX idx_careplan_active ON care_plans(patient_id, status)
    WHERE status = 'active';
```

**`goals` JSONB(SMARTç›®æ¨™ã®ä¾‹):**

```json
{
  "goals": [
    {
      "id": "goal-001",
      "description": "3ãƒ¶æœˆä»¥å†…ã«è‡ªåŠ›ã§ã®è»Šæ¤…å­ç§»ä¹—ã‚’å¯èƒ½ã«ã™ã‚‹",
      "category": "rehabilitation",
      "priority": "high",
      "startDate": "2025-12-01",
      "targetDate": "2026-03-01",
      "achievementStatus": "in_progress",
      "measurableOutcome": {
        "metric": "Barthel Index - Transfer",
        "baseline": 5,
        "target": 10,
        "current": 7,
        "lastMeasured": "2025-12-10"
      },
      "addresses": ["condition-id-123"]  // å¯¾è±¡ç—…åã¸ã®å‚ç…§
    }
  ]
}
```

**`activities` JSONB:**

```json
{
  "activities": [
    {
      "id": "activity-001",
      "category": "physiotherapy",
      "description": "ç†å­¦ç™‚æ³•å£«ã«ã‚ˆã‚‹ç§»ä¹—è¨“ç·´",
      "frequency": "é€±2å›",
      "duration": "40åˆ†",
      "performerType": "physical_therapist",
      "status": "in_progress",
      "scheduledVisits": ["schedule-id-xxx", "schedule-id-yyy"]
    },
    {
      "id": "activity-002",
      "category": "medication",
      "description": "ç–¼ç—›ç®¡ç†ã«ã‚ˆã‚‹è¨“ç·´ä¿ƒé€²",
      "medicationRef": "med-order-789"
    }
  ]
}
```

### 6.2 ãƒ†ãƒ¼ãƒ–ãƒ«: `acp_records` (Advance Care Planning)

**äººç”Ÿã®æœ€çµ‚æ®µéšã«ãŠã‘ã‚‹æ„æ€æ±ºå®šæ”¯æ´ã®è¨˜éŒ²:**

```sql
CREATE TABLE acp_records (
    acp_id varchar(36) NOT NULL,
    patient_id varchar(36) NOT NULL,

    recorded_date date NOT NULL,
    version int NOT NULL DEFAULT 1,  -- æ„æ€å¤‰æ›´ã®å±¥æ­´ç®¡ç†
    status varchar(20) NOT NULL,  -- "draft" | "active" | "superseded"

    -- æ„æ€æ±ºå®šã®ä¸»ä½“
    decision_maker varchar(20) NOT NULL,  -- "patient" | "proxy" | "guardian"
    proxy_person_id varchar(36),  -- key_personsã¸ã®å‚ç…§

    -- ACPå†…å®¹
    directives jsonb NOT NULL,  -- å…·ä½“çš„æŒ‡ç¤º(DNAR, äººå·¥å‘¼å¸å™¨ç­‰)
    values_narrative text,  -- ä¾¡å€¤è¦³ã®è¨˜è¿°

    -- æ³•çš„æ–‡æ›¸
    legal_documents jsonb,  -- åŒæ„æ›¸ã€ãƒªãƒ“ãƒ³ã‚°ã‚¦ã‚£ãƒ«ç­‰ã®ãƒªãƒ³ã‚¯

    -- ACPãƒ—ãƒ­ã‚»ã‚¹
    discussion_log jsonb,  -- è©±ã—åˆã„ã®å±¥æ­´

    -- ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£
    data_sensitivity varchar(20) NOT NULL DEFAULT 'highly_confidential',
    access_restricted_to jsonb,  -- ã‚¢ã‚¯ã‚»ã‚¹è¨±å¯ãƒªã‚¹ãƒˆ

    created_by varchar(36) NOT NULL,
    created_at timestamptz NOT NULL DEFAULT CURRENT_TIMESTAMP,

    PRIMARY KEY (patient_id, acp_id),
    CONSTRAINT fk_patient FOREIGN KEY (patient_id) REFERENCES patients(patient_id)
) INTERLEAVE IN PARENT patients ON DELETE CASCADE;

-- æœ€æ–°æœ‰åŠ¹ãªACPã®å–å¾—
CREATE INDEX idx_acp_active ON acp_records(patient_id, version DESC)
    WHERE status = 'active';
```

**`directives` JSONBè©³ç´°:**

```json
{
  "cpr": {
    "decision": "do_not_attempt",
    "decisionDisplay": "å¿ƒè‚ºè˜‡ç”Ÿã‚’å¸Œæœ›ã—ãªã„(DNAR)",
    "decisionDate": "2025-10-15",
    "circumstances": "ã„ã‹ãªã‚‹çŠ¶æ³ã§ã‚‚",
    "rationale": "è‡ªç„¶ãªæœ€æœŸã‚’è¿ãˆãŸã„"
  },

  "artificialRespiration": {
    "decision": "refuse",
    "decisionDisplay": "äººå·¥å‘¼å¸å™¨è£…ç€ã‚’æ‹’å¦",
    "circumstances": "å›å¾©è¦‹è¾¼ã¿ãŒãªã„å ´åˆ",
    "trialPeriod": null
  },

  "artificialNutrition": {
    "peg": {
      "decision": "refuse",
      "decisionDisplay": "èƒƒã‚ã†é€ è¨­ã‚’å¸Œæœ›ã—ãªã„"
    },
    "ivFluids": {
      "decision": "short_term_only",
      "decisionDisplay": "ç‚¹æ»´ã¯çŸ­æœŸé–“ã®ã¿è¨±å®¹",
      "maxDuration": "2é€±é–“",
      "purpose": "è‹¦ç—›ç·©å’Œç›®çš„ã®ã¿"
    },
    "nasogastricTube": {
      "decision": "refuse"
    }
  },

  "organDonation": {
    "decision": "not_registered",
    "futureConsideration": "æ¤œè¨ä¸­"
  },

  "preferredPlaceOfDeath": {
    "first": "home",
    "second": "hospice",
    "third": "hospital",
    "specificRequests": "è‡ªå®…ã®å’Œå®¤ã§å®¶æ—ã¨éã”ã—ãŸã„"
  },

  "painManagement": {
    "priority": "symptom_relief_over_longevity",
    "acceptableSedation": "deep_sedation_if_needed",
    "notes": "è‹¦ç—›ã®é™¤å»ã‚’æœ€å„ªå…ˆã€‚æ„è­˜ãƒ¬ãƒ™ãƒ«ã®ä½ä¸‹ã¯è¨±å®¹ã€‚"
  },

  "decisionMakerProxy": {
    "primary": {
      "keyPersonId": "kp-001",
      "name": "å±±ç”° èŠ±å­",
      "relationship": "spouse",
      "authority": "full"
    },
    "alternate": {
      "keyPersonId": "kp-002",
      "name": "å±±ç”° å¤ªéƒ",
      "relationship": "son"
    }
  }
}
```

**`discussion_log` JSONB:**

```json
{
  "discussions": [
    {
      "date": "2025-10-15",
      "participants": [
        {"role": "patient", "name": "å±±ç”° ä¸‰éƒ"},
        {"role": "family", "name": "å±±ç”° èŠ±å­", "relationship": "spouse"},
        {"role": "physician", "id": "doctor-456", "name": "ç”°ä¸­åŒ»å¸«"},
        {"role": "nurse", "id": "nurse-789", "name": "ä½è—¤çœ‹è­·å¸«"}
      ],
      "location": "patient_home",
      "duration_minutes": 60,
      "topics_discussed": [
        "DNAR",
        "äººå·¥æ „é¤Šã®é¸æŠ",
        "ç™‚é¤Šå ´æ‰€ã®å¸Œæœ›"
      ],
      "patient_understanding": "good",
      "patient_emotional_state": "calm_and_accepting",
      "family_agreement": "unanimous",
      "notes": "æœ¬äººã®æ„æ€ã¯æ˜ç¢ºã€‚å®¶æ—ã‚‚æœ¬äººã®å¸Œæœ›ã‚’å°Šé‡ã™ã‚‹ã“ã¨ã§åˆæ„ã€‚æ¬¡å›3ãƒ¶æœˆå¾Œã«å†ç¢ºèªäºˆå®šã€‚",
      "next_review_date": "2026-01-15"
    }
  ]
}
```

**`legal_documents` JSONB:**

```json
{
  "documents": [
    {
      "type": "living_will",
      "title": "ãƒªãƒ“ãƒ³ã‚°ã‚¦ã‚£ãƒ«",
      "signed_date": "2025-10-15",
      "file_url": "gs://visitas-legal-docs/patient-xxx/living-will-signed.pdf",
      "file_hash": "sha256:abcdef123456...",
      "witnesses": [
        {"name": "ç”°ä¸­åŒ»å¸«", "id": "doctor-456"},
        {"name": "ä½è—¤çœ‹è­·å¸«", "id": "nurse-789"}
      ]
    },
    {
      "type": "power_of_attorney",
      "title": "åŒ»ç™‚ä»£ç†æ¨©å§”ä»»çŠ¶",
      "proxy_name": "å±±ç”° èŠ±å­",
      "signed_date": "2025-10-15",
      "file_url": "gs://visitas-legal-docs/patient-xxx/proxy-authorization.pdf"
    }
  ]
}
```

### 6.3 ãƒ†ãƒ¼ãƒ–ãƒ«: `medication_orders` (å‡¦æ–¹ã‚ªãƒ¼ãƒ€ãƒ¼)

```sql
CREATE TABLE medication_orders (
    order_id varchar(36) NOT NULL,
    patient_id varchar(36) NOT NULL,

    status varchar(20) NOT NULL,  -- "active" | "on-hold" | "cancelled" | "completed" | "entered-in-error"
    intent varchar(20) NOT NULL,  -- "order" | "plan"

    medication jsonb NOT NULL,  -- è–¬å‰¤æƒ…å ±(YJã‚³ãƒ¼ãƒ‰ã€ä¸€èˆ¬åã€å•†å“å)
    dosage_instruction jsonb NOT NULL,  -- ç”¨æ³•ç”¨é‡(FHIR DosageInstructionæº–æ‹ )

    prescribed_date date NOT NULL,
    prescribed_by varchar(36) NOT NULL,  -- åŒ»å¸«ID

    dispense_pharmacy jsonb,  -- èª¿å‰¤è–¬å±€æƒ…å ±

    reason_reference varchar(36),  -- å‡¦æ–¹ç†ç”±(ç—…åIDã¸ã®å‚ç…§)

    PRIMARY KEY (patient_id, order_id),
    CONSTRAINT fk_patient FOREIGN KEY (patient_id) REFERENCES patients(patient_id)
) INTERLEAVE IN PARENT patients ON DELETE CASCADE;

-- æœ‰åŠ¹å‡¦æ–¹ã®æ¤œç´¢
CREATE INDEX idx_medication_active ON medication_orders(patient_id, status)
    WHERE status = 'active';
```

**`medication` JSONB:**

```json
{
  "coding": [
    {
      "system": "urn:oid:jpn-yj-code",
      "code": "2171022F1024",
      "display": "ã‚¢ãƒ¢ã‚­ã‚·ã‚·ãƒªãƒ³ã‚«ãƒ—ã‚»ãƒ«250mg"
    }
  ],
  "genericName": "ã‚¢ãƒ¢ã‚­ã‚·ã‚·ãƒªãƒ³",
  "brandName": "ã‚µãƒ¯ã‚·ãƒªãƒ³",
  "form": "capsule",
  "strength": "250mg"
}
```

**`dosage_instruction` JSONB(FHIRæº–æ‹ ):**

```json
{
  "text": "1å›1ã‚«ãƒ—ã‚»ãƒ«(250mg) 1æ—¥3å› æœæ˜¼å¤•é£Ÿå¾Œ 7æ—¥é–“",
  "timing": {
    "repeat": {
      "frequency": 3,
      "period": 1,
      "periodUnit": "d",
      "when": ["ACM", "ACD", "ACV"]  // æœé£Ÿå¾Œã€æ˜¼é£Ÿå¾Œã€å¤•é£Ÿå¾Œ
    }
  },
  "route": {
    "coding": [{"code": "PO", "display": "çµŒå£"}]
  },
  "doseAndRate": [{
    "doseQuantity": {"value": 1, "unit": "capsule"}
  }],
  "duration": {"value": 7, "unit": "d"},
  "totalDailyDose": {"value": 750, "unit": "mg"},
  "additionalInstruction": "ç©ºè…¹æ™‚æœç”¨ã¯é¿ã‘ã‚‹",
  "patientInstruction": "å¿…ãš7æ—¥é–“é£²ã¿åˆ‡ã£ã¦ãã ã•ã„"
}
```

---

## 7. è¨ªå•ãƒ­ã‚¸ã‚¹ãƒ†ã‚£ã‚¯ã‚¹ã¨Route Optimizationçµ±åˆ

### 7.1 è¨­è¨ˆæ€æƒ³: ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹é§†å‹•å‹ãƒ«ãƒ¼ãƒˆæœ€é©åŒ–

Google Maps Route Optimization APIã¯ã€è¨ªå•çœ‹è­·ã«ãŠã‘ã‚‹ã€Œç§»å‹•ã®ç„¡é§„ã€ã‚’æ•°å­¦çš„ã«æœ€å°åŒ–ã™ã‚‹å¼·åŠ›ãªãƒ„ãƒ¼ãƒ«ã ãŒã€ãã®çœŸä¾¡ã‚’ç™ºæ®ã™ã‚‹ã«ã¯**ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ãŒAPIä»•æ§˜ã«åˆã‚ã›ãŸæ§‹é€ ã‚’æŒã¤**å¿…è¦ãŒã‚ã‚‹ã€‚

**çµ±åˆã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£:**

```
Spanner DB (Source of Truth)
  â†“
[visit_schedules + logistics_locations]
  â†“ ãƒ‡ãƒ¼ã‚¿å¤‰æ›ãƒ¬ã‚¤ãƒ¤ãƒ¼
ShipmentModel JSONç”Ÿæˆ
  â†“
Route Optimization API Request
  â†“ æœ€é©åŒ–çµæœ
visit_schedules.result_metrics æ›´æ–°(åˆ°ç€äºˆå®šæ™‚åˆ»ã€èµ°è¡Œè·é›¢ç­‰)
  â†“
ãƒ¢ãƒã‚¤ãƒ«ã‚¢ãƒ—ãƒªã¸Pushé€šçŸ¥
```

### 7.2 ãƒ†ãƒ¼ãƒ–ãƒ«: `visit_schedules` (è¨ªå•ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«)

```sql
CREATE TABLE visit_schedules (
    schedule_id varchar(36) NOT NULL,
    patient_id varchar(36) NOT NULL,

    visit_date date NOT NULL,
    visit_type varchar(50) NOT NULL,  -- "regular" | "emergency" | "initial_assessment" | "terminal_care"

    -- è¨ªå•æ™‚é–“æ 
    time_window_start time,
    time_window_end time,
    estimated_duration_minutes int NOT NULL,  -- ã‚µãƒ¼ãƒ“ã‚¹æä¾›æ™‚é–“

    -- ã‚¹ã‚¿ãƒƒãƒ•å‰²å½“
    assigned_staff_id varchar(36),
    assigned_vehicle_id varchar(36),

    -- ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹
    status varchar(20) NOT NULL,  -- "draft" | "optimized" | "assigned" | "in_progress" | "completed" | "cancelled"

    -- Route Optimizationçµ±åˆ
    priority_score int NOT NULL DEFAULT 5,  -- 1(ä½)-10(é«˜)
    constraints jsonb,  -- API Shipmentã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã®VisitRequestç›¸å½“
    optimization_result jsonb,  -- API Responseæ ¼ç´

    -- ã‚±ã‚¢è¨ˆç”»ã¨ã®ç´ä»˜ã‘
    care_plan_ref varchar(36),
    activity_ref varchar(36),

    created_at timestamptz NOT NULL DEFAULT CURRENT_TIMESTAMP,
    updated_at timestamptz NOT NULL DEFAULT CURRENT_TIMESTAMP,

    PRIMARY KEY (patient_id, schedule_id),
    CONSTRAINT fk_patient FOREIGN KEY (patient_id) REFERENCES patients(patient_id)
) INTERLEAVE IN PARENT patients ON DELETE CASCADE;

-- æ—¥ä»˜ãƒ»ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹åˆ¥æ¤œç´¢
CREATE INDEX idx_schedule_date_status ON visit_schedules(visit_date, status);
CREATE INDEX idx_schedule_staff ON visit_schedules(assigned_staff_id, visit_date);
```

**`constraints` JSONB(Route Optimization API `VisitRequest`ãƒãƒƒãƒ”ãƒ³ã‚°):**

```json
{
  "arrivalLocation": {
    "latitude": 35.6895,
    "longitude": 139.6917
  },
  "duration": "45m",  // ISO 8601 duration

  "timeWindows": [
    {
      "startTime": "2025-12-12T10:00:00+09:00",
      "endTime": "2025-12-12T12:00:00+09:00"
    }
  ],

  "loadDemands": {
    "nursing_skill_level": {"amount": "3"},  // æ­£çœ‹è­·å¸«ãƒ¬ãƒ™ãƒ«å¿…è¦
    "physical_load": {"amount": "2"},  // å…¥æµ´ä»‹åŠ©ç­‰ã®èº«ä½“è² è·
    "equipment_weight_kg": {"amount": "5"}
  },

  "visitTypes": ["pickup_and_delivery"],  // è–¬å‰¤å—å–+è¨ªå•ã®ã‚±ãƒ¼ã‚¹

  "label": "æ‚£è€…: å±±ç”°ä¸‰éƒæ§˜ / è¨ªå•çœ‹è­·(å…¥æµ´ä»‹åŠ©å«ã‚€)",

  "tags": ["requires_parking_permit", "wheelchair_access_needed"],

  "cost": 100,  // ãƒ™ãƒ¼ã‚¹ã‚³ã‚¹ãƒˆ
  "penaltyCost": 1000  // æœªè¨ªå•æ™‚ã®ãƒšãƒŠãƒ«ãƒ†ã‚£(é«˜å„ªå…ˆåº¦æ‚£è€…)
}
```

**`optimization_result` JSONB(API Responseã®ãƒ¡ãƒˆãƒªã‚¯ã‚¹æ ¼ç´):**

```json
{
  "optimized_at": "2025-12-11T20:00:00Z",
  "route_id": "route-abc-123",
  "vehicle_index": 2,
  "visit_index": 3,

  "timing": {
    "arrival_time": "2025-12-12T10:25:00+09:00",
    "departure_time": "2025-12-12T11:10:00+09:00",
    "waiting_time_minutes": 5,
    "service_time_minutes": 45
  },

  "travel_from_previous": {
    "distance_meters": 3200,
    "duration_seconds": 480,
    "mode": "car"
  },

  "metrics": {
    "total_route_distance_km": 45.3,
    "total_route_duration_hours": 6.5,
    "visits_completed": 8,
    "optimization_score": 92
  }
}
```

### 7.3 ãƒ†ãƒ¼ãƒ–ãƒ«: `logistics_locations` (è¨ªå•å…ˆç‰©ç†æƒ…å ±)

æ‚£è€…å®…ã ã‘ã§ãªãã€ã‚¹ãƒ†ãƒ¼ã‚·ãƒ§ãƒ³ã€è–¬å±€ã€é§è»Šå ´ã€æ¤œæŸ»æ©Ÿé–¢ãªã©ãƒ­ã‚¸ã‚¹ãƒ†ã‚£ã‚¯ã‚¹ã«é–¢ã‚ã‚‹å…¨ã¦ã®å ´æ‰€ã‚’ç®¡ç†ã€‚

```sql
CREATE TABLE logistics_locations (
    location_id varchar(36) NOT NULL,
    location_type varchar(50) NOT NULL,  -- "patient_home" | "station" | "pharmacy" | "parking" | "lab"

    -- åœ°ç†åº§æ¨™
    geolocation geography(point) NOT NULL,  -- PostGISã‚¹ã‚¿ã‚¤ãƒ«ã®åœ°ç†å‹
    latitude numeric(10, 7) NOT NULL,
    longitude numeric(10, 7) NOT NULL,

    -- ä½æ‰€
    address jsonb NOT NULL,

    -- é–¢é€£ã‚¨ãƒ³ãƒ†ã‚£ãƒ†ã‚£
    related_entity_type varchar(50),  -- "patient" | "organization"
    related_entity_id varchar(36),

    -- ãƒ­ã‚¸ã‚¹ãƒ†ã‚£ã‚¯ã‚¹è©³ç´°
    logistics_meta jsonb NOT NULL,  -- é§è»Šæƒ…å ±ã€å…¥é¤¨æ–¹æ³•ã€TransitionAttributesç­‰

    active boolean NOT NULL DEFAULT true,
    created_at timestamptz NOT NULL DEFAULT CURRENT_TIMESTAMP,
    updated_at timestamptz NOT NULL DEFAULT CURRENT_TIMESTAMP,

    PRIMARY KEY (location_id)
);

-- åœ°ç†æ¤œç´¢ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹
CREATE INDEX idx_location_geo ON logistics_locations USING gist(geolocation);
CREATE INDEX idx_location_type ON logistics_locations(location_type);
```

**`logistics_meta` JSONB(æ‚£è€…å®…ã®ä¾‹):**

```json
{
  "entryInstructions": {
    "hasAutoLock": true,
    "unlockMethod": "key_box",
    "keyBoxLocation": "ã‚¬ã‚¹ãƒ¡ãƒ¼ã‚¿ãƒ¼å†…",
    "unlockCode": "**ENCRYPTED**",
    "specialNotes": "ç„é–¢å‘¼ã³éˆ´ã¯èã“ãˆã«ãã„ã€‚åˆ°ç€5åˆ†å‰ã«æºå¸¯ã¸é€£çµ¡æ¨å¥¨ã€‚",
    "emergencyKeyHolder": {"name": "å±±ç”°èŠ±å­", "phone": "090-xxxx-xxxx"}
  },

  "parkingInstructions": {
    "hasPrivateParking": false,
    "nearbyParkingSpots": [
      {
        "id": "parking-001",
        "name": "ã‚¿ã‚¤ãƒ ã‚ºæ–°å®¿è¥¿å£",
        "latitude": 35.6890,
        "longitude": 139.6915,
        "walking_distance_meters": 150,
        "walking_time_minutes": 3,
        "cost_per_hour_jpy": 400,
        "accepts_medical_discount": true,
        "spaces_available_typical": 20
      }
    ],
    "streetParkingAllowed": false,
    "loadingZone": {"available": false}
  },

  "buildingAccess": {
    "type": "apartment",
    "floor": 5,
    "hasElevator": true,
    "elevatorWaitTimeAvgMinutes": 3,
    "stairsOnly": false,
    "wheelchairAccessible": true,
    "narrowHallways": false
  },

  "transitionDelaySeconds": 300,  // åˆ°ç€â†’ã‚µãƒ¼ãƒ“ã‚¹é–‹å§‹ã®æ¨™æº–ãƒ­ã‚¹æ™‚é–“

  "safetyNotes": ["ãƒšãƒƒãƒˆ(çŒ«2åŒ¹)ãŒç„é–¢ã«å‡ºã¦ãã‚‹å¯èƒ½æ€§", "æ®µå·®æ³¨æ„"],

  "photos": [
    {"type": "building_entrance", "url": "gs://locations/loc-xxx/entrance.jpg"},
    {"type": "parking_nearby", "url": "gs://locations/loc-xxx/parking.jpg"}
  ]
}
```

### 7.4 ãƒ†ãƒ¼ãƒ–ãƒ«: `route_optimization_jobs` (æœ€é©åŒ–å®Ÿè¡Œå±¥æ­´)

```sql
CREATE TABLE route_optimization_jobs (
    job_id varchar(36) NOT NULL,
    execution_date date NOT NULL,

    status varchar(20) NOT NULL,  -- "pending" | "running" | "completed" | "failed"

    -- API Request
    request_payload jsonb NOT NULL,  -- é€ä¿¡ã—ãŸShipmentModelã®å®Œå…¨ãªã‚³ãƒ”ãƒ¼

    -- API Response
    response_payload jsonb,
    optimization_metrics jsonb,  -- ç·èµ°è¡Œè·é›¢ã€æ™‚é–“ã€ã‚³ã‚¹ãƒˆå‰Šæ¸›ç‡ç­‰

    execution_started_at timestamptz,
    execution_completed_at timestamptz,
    execution_duration_seconds int,

    -- ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°
    error_message text,
    retry_count int DEFAULT 0,

    created_by varchar(36),  -- ã‚·ã‚¹ãƒ†ãƒ ã¾ãŸã¯ç®¡ç†è€…ID

    PRIMARY KEY (job_id)
);

CREATE INDEX idx_optimization_date ON route_optimization_jobs(execution_date DESC);
```

---

## 8. Firestore: ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ ã‚³ãƒ©ãƒœãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³å±¤

### 8.1 Spannerã¨ã®å½¹å‰²åˆ†æ‹…

| ãƒ‡ãƒ¼ã‚¿ç¨®åˆ¥ | ä¿å­˜å…ˆ | ç†ç”± |
|---|---|---|
| **ãƒã‚¹ã‚¿ãƒ¼ãƒ‡ãƒ¼ã‚¿**(æ‚£è€…ã€ä¿é™ºã€ç—…å) | **Spanner** | å¼·æ•´åˆæ€§ã€è¤‡é›‘ãªã‚¯ã‚¨ãƒªã€ç›£æŸ»è¦ä»¶ |
| **åŒ»ç™‚è¨˜éŒ²**(SOAPã€å‡¦æ–¹) | **Spanner** | æ³•çš„ä¿å­˜ç¾©å‹™ã€ACIDç‰¹æ€§å¿…é ˆ |
| **è¨ªå•ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«** | **Spanner** | ãƒ«ãƒ¼ãƒˆæœ€é©åŒ–ã®è¨ˆç®—åŸºç›¤ |
| **ãƒãƒ£ãƒƒãƒˆãƒ¡ãƒƒã‚»ãƒ¼ã‚¸** | **Firestore** | ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ åŒæœŸã€ã‚ªãƒ•ãƒ©ã‚¤ãƒ³å¯¾å¿œ |
| **ä½ç½®æƒ…å ±å…±æœ‰** | **Firestore** | é«˜é »åº¦æ›´æ–°ã€ä½ãƒ¬ã‚¤ãƒ†ãƒ³ã‚· |
| **åœ¨åº«ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹**(åŒ»ç™‚ææ–™) | **Firestore** | ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ åœ¨åº«ç¢ºèª |
| **é€šçŸ¥ã‚­ãƒ¥ãƒ¼** | **Firestore** | Pushé€šçŸ¥ãƒˆãƒªã‚¬ãƒ¼ |

### 8.2 Firestoreã‚³ãƒ¬ã‚¯ã‚·ãƒ§ãƒ³è¨­è¨ˆ

#### ã‚³ãƒ¬ã‚¯ã‚·ãƒ§ãƒ³: `coordination_chats`

```
/coordination_chats/{chatRoomId}
  â”œâ”€ metadata (Document)
  â”‚   â”œâ”€ patientId: "patient-123"
  â”‚   â”œâ”€ participants: ["doctor-456", "nurse-789", "caremgr-012"]
  â”‚   â”œâ”€ createdAt: Timestamp
  â”‚   â””â”€ lastMessageAt: Timestamp
  â”‚
  â””â”€ messages (Subcollection)
      â””â”€ {messageId} (Document)
          â”œâ”€ senderId: "nurse-789"
          â”œâ”€ senderName: "ä½è—¤çœ‹è­·å¸«"
          â”œâ”€ content: "æœ¬æ—¥è¨ªå•æ™‚ã€SpO2 92%ã«ä½ä¸‹ã€‚é…¸ç´ æµé‡2L/åˆ†ã¸å¤‰æ›´ã€‚"
          â”œâ”€ type: "text" | "vital_alert" | "image" | "file"
          â”œâ”€ timestamp: Timestamp
          â”œâ”€ readBy: {"doctor-456": Timestamp, "nurse-789": Timestamp}
          â”œâ”€ priority: "routine" | "urgent" | "stat"
          â”œâ”€ attachments: [
          â”‚   {"type": "vital_record", "spannerRef": "obs-id-xxx"}
          â”‚ ]
          â””â”€ reactions: {"ğŸ‘": ["doctor-456"], "ç¢ºèª": ["caremgr-012"]}
```

**ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒ«ãƒ¼ãƒ«(ä¾‹):**

```javascript
match /coordination_chats/{chatRoomId}/messages/{messageId} {
  allow read: if request.auth != null &&
    request.auth.uid in get(/databases/$(database)/documents/coordination_chats/$(chatRoomId)/metadata).data.participants;

  allow create: if request.auth != null &&
    request.resource.data.senderId == request.auth.uid;
}
```

#### ã‚³ãƒ¬ã‚¯ã‚·ãƒ§ãƒ³: `staff_locations` (ã‚¹ã‚¿ãƒƒãƒ•ä½ç½®æƒ…å ±)

```
/staff_locations/{staffId} (Document)
  â”œâ”€ currentLocation: GeoPoint(latitude, longitude)
  â”œâ”€ accuracy: 10  // meters
  â”œâ”€ timestamp: Timestamp
  â”œâ”€ status: "on_route" | "at_patient" | "at_station" | "off_duty"
  â”œâ”€ currentVisitId: "schedule-xxx"  // Spannerã¸ã®å‚ç…§
  â””â”€ nextVisitETA: Timestamp
```

**ä½ç½®æƒ…å ±æ›´æ–°é »åº¦:**
- ç§»å‹•ä¸­: 30ç§’ã”ã¨
- è¨ªå•ä¸­: æ›´æ–°åœæ­¢(ãƒ—ãƒ©ã‚¤ãƒã‚·ãƒ¼ä¿è­·)
- ç·Šæ€¥æ™‚: 10ç§’ã”ã¨

---

## 9. ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£å®Ÿè£…è¦ä»¶

### 9.1 å¤šå±¤é˜²å¾¡ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£

```
ãƒ¬ã‚¤ãƒ¤ãƒ¼1: ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯å¢ƒç•Œ
  â”œâ”€ Cloud Armor (DDoSé˜²å¾¡ã€WAF)
  â””â”€ Identity-Aware Proxy (IAP) - ã‚¼ãƒ­ãƒˆãƒ©ã‚¹ãƒˆã‚¢ã‚¯ã‚»ã‚¹

ãƒ¬ã‚¤ãƒ¤ãƒ¼2: èªè¨¼ãƒ»èªå¯
  â”œâ”€ Firebase Authentication (MFAå¿…é ˆ)
  â”œâ”€ ã‚«ã‚¹ã‚¿ãƒ ã‚¯ãƒ¬ãƒ¼ãƒ (role: "doctor" | "nurse" | "admin")
  â””â”€ Spanner IAM (roles/spanner.databaseUser)

ãƒ¬ã‚¤ãƒ¤ãƒ¼3: ãƒ‡ãƒ¼ã‚¿æš—å·åŒ–
  â”œâ”€ è»¢é€æ™‚: TLS 1.3 (å¼·åˆ¶)
  â”œâ”€ ä¿å­˜æ™‚: CMEK (Cloud KMSç®¡ç†)
  â””â”€ ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³å±¤: æ©Ÿå¾®ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰å€‹åˆ¥æš—å·åŒ–(AEAD)

ãƒ¬ã‚¤ãƒ¤ãƒ¼4: ã‚¢ã‚¯ã‚»ã‚¹åˆ¶å¾¡
  â”œâ”€ Row-Level Security (RLS) - æ‚£è€…å˜ä½
  â”œâ”€ Column-Level Access (VIEWã«ã‚ˆã‚‹ãƒã‚¹ã‚­ãƒ³ã‚°)
  â””â”€ Firestore Security Rules

ãƒ¬ã‚¤ãƒ¤ãƒ¼5: ç›£æŸ»ãƒ»æ¤œçŸ¥
  â”œâ”€ Cloud Audit Logs (5å¹´ä¿å­˜)
  â”œâ”€ Security Command Center (ç•°å¸¸æ¤œçŸ¥)
  â””â”€ ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ãƒ­ã‚° (èª°ãŒä½•ã‚’è¦‹ãŸã‹)
```

### 9.2 Row-Level Security (RLS) å®Ÿè£…

**æ‚£è€…ãƒ‡ãƒ¼ã‚¿ã¸ã®ã‚¢ã‚¯ã‚»ã‚¹åˆ¶é™:**

```sql
-- æ‹…å½“æ‚£è€…ã®ã¿é–²è¦§å¯èƒ½ã«ã™ã‚‹ãƒ“ãƒ¥ãƒ¼
CREATE VIEW view_my_patients SQL SECURITY INVOKER AS
SELECT p.*
FROM patients p
INNER JOIN staff_patient_assignments spa
  ON p.patient_id = spa.patient_id
WHERE spa.staff_id = CURRENT_USER()  -- Firebase UIDã‚’CURRENT_USER()ã¨ã—ã¦æ¸¡ã™
  AND spa.assignment_status = 'active'
  AND p.is_deleted = false;
```

**ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³å±¤ã§ã®å®Ÿè£…:**

```go
// Firebase ID Tokenã‹ã‚‰ãƒ¦ãƒ¼ã‚¶ãƒ¼æƒ…å ±å–å¾—
func (db *SpannerDB) GetMyPatients(ctx context.Context, firebaseUID string) ([]Patient, error) {
    // SET SESSION AUTHORIZATION ã§Spannerã®ã‚»ãƒƒã‚·ãƒ§ãƒ³ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚’è¨­å®š
    _, err := db.client.Apply(ctx, []*spanner.Mutation{
        spanner.Insert("sessions",
            []string{"session_id", "firebase_uid"},
            []interface{}{uuid.New().String(), firebaseUID}),
    })

    // ãƒ“ãƒ¥ãƒ¼çµŒç”±ã§ã‚¯ã‚¨ãƒª
    stmt := spanner.Statement{
        SQL: "SELECT * FROM view_my_patients ORDER BY full_name_kana",
    }
    iter := db.client.Single().Query(ctx, stmt)
    defer iter.Stop()

    // çµæœå‡¦ç†...
}
```

### 9.3 Column-Level Masking (å€‹äººæƒ…å ±ãƒã‚¹ã‚­ãƒ³ã‚°)

**é–‹ç™ºè€…ãƒ»ã‚¢ãƒŠãƒªã‚¹ãƒˆå‘ã‘ã®åŒ¿ååŒ–ãƒ“ãƒ¥ãƒ¼:**

```sql
CREATE VIEW view_patients_anonymized SQL SECURITY DEFINER AS
SELECT
    patient_id,
    'MASKED' AS full_name,
    'MASKED' AS full_name_kana,
    DATE_TRUNC('month', birth_date) AS birth_month,  -- æ—¥ä»˜ã¯æœˆå˜ä½ã«ä¸¸ã‚ã‚‹
    gender,
    (addresses #- '{0,line}' #- '{0,postalCode}') AS address_summary,  -- ç•ªåœ°å‰Šé™¤
    NULL AS contact_points,
    created_at
FROM patients
WHERE is_deleted = false;

-- ä»˜ä¸æ¨©é™
GRANT SELECT ON view_patients_anonymized TO ROLE 'data_analyst';
```

### 9.4 ç›£æŸ»ãƒ­ã‚°è¦ä»¶

**è¨˜éŒ²å¿…é ˆã‚¤ãƒ™ãƒ³ãƒˆ:**

| ã‚¤ãƒ™ãƒ³ãƒˆ | ãƒ­ã‚°å‡ºåŠ›å…ˆ | ä¿å­˜æœŸé–“ | å†…å®¹ |
|---|---|---|---|
| **æ‚£è€…æƒ…å ±é–²è¦§** | Spanner `audit_access_logs` | 5å¹´ | user_id, patient_id, accessed_fields, timestamp, IP |
| **ãƒ‡ãƒ¼ã‚¿å¤‰æ›´** | Cloud Audit Logs | 10å¹´ | Before/Afterå€¤ã€å¤‰æ›´ç†ç”± |
| **ACPé–²è¦§ãƒ»å¤‰æ›´** | å°‚ç”¨ãƒ†ãƒ¼ãƒ–ãƒ« `acp_audit_logs` | æ°¸ä¹… | é–²è¦§è€…ã€å¤‰æ›´å†…å®¹ã€æ‚£è€…åŒæ„ã®æœ‰ç„¡ |
| **æš—å·éµä½¿ç”¨** | Cloud KMS Audit Logs | 10å¹´ | éµIDã€æ“ä½œ(encrypt/decrypt)ã€å‘¼ã³å‡ºã—å…ƒ |
| **ãƒ‡ãƒ¼ã‚¿ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆ** | `data_export_logs` | 10å¹´ | ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆç¯„å›²ã€å—é ˜è€…ã€ç›®çš„ |

**ç›£æŸ»ãƒ†ãƒ¼ãƒ–ãƒ«ä¾‹:**

```sql
CREATE TABLE audit_access_logs (
    log_id varchar(36) NOT NULL,
    event_time timestamptz NOT NULL DEFAULT CURRENT_TIMESTAMP,

    actor_id varchar(36) NOT NULL,  -- Firebase UID
    actor_role varchar(50) NOT NULL,
    actor_ip_address varchar(45),

    action varchar(50) NOT NULL,  -- "view" | "update" | "delete" | "export"
    resource_type varchar(50) NOT NULL,  -- "patient" | "soap_note" | "acp_record"
    resource_id varchar(36) NOT NULL,

    accessed_fields jsonb,  -- é–²è¦§ã—ãŸã‚«ãƒ©ãƒ åã®ãƒªã‚¹ãƒˆ
    change_details jsonb,  -- Before/After

    purpose varchar(200),  -- ã‚¢ã‚¯ã‚»ã‚¹ç›®çš„(è¨ºç™‚ã€è«‹æ±‚ã€ç ”ç©¶ç­‰)

    PRIMARY KEY (log_id)
);

-- æ™‚ç³»åˆ—æ¤œç´¢ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹
CREATE INDEX idx_audit_time ON audit_access_logs(event_time DESC);
CREATE INDEX idx_audit_actor ON audit_access_logs(actor_id, event_time DESC);
CREATE INDEX idx_audit_resource ON audit_access_logs(resource_id, event_time DESC);
```

---

## 10. é‹ç”¨ãƒ»ç›£æŸ»ãƒ»ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—æˆ¦ç•¥

### 10.1 ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ãƒãƒªã‚·ãƒ¼

| ãƒ‡ãƒ¼ã‚¿ç¨®åˆ¥ | RPO (ç›®æ¨™å¾©æ—§æ™‚ç‚¹) | RTO (ç›®æ¨™å¾©æ—§æ™‚é–“) | ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—æ–¹å¼ |
|---|---|---|---|
| **Spanner** | 1æ™‚é–“ | 4æ™‚é–“ | è‡ªå‹•ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—(24æ™‚é–“ã”ã¨) + PITR(Point-in-Time Recovery) |
| **Firestore** | 24æ™‚é–“ | 8æ™‚é–“ | æ—¥æ¬¡ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆ â†’ Cloud Storage |
| **Cloud Storage** | 0 (ãƒãƒ¼ã‚¸ãƒ§ãƒ‹ãƒ³ã‚°) | å³æ™‚ | ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆãƒãƒ¼ã‚¸ãƒ§ãƒ‹ãƒ³ã‚°æœ‰åŠ¹åŒ– |

**Spanner PITRã«ã‚ˆã‚‹èª¤æ“ä½œå¾©æ—§ã‚·ãƒŠãƒªã‚ª:**

```bash
# 2025-12-12 10:30ã«èª¤ã£ã¦æ‚£è€…ãƒ‡ãƒ¼ã‚¿ã‚’å‰Šé™¤ã—ãŸå ´åˆ
gcloud spanner databases restore \
  --source-database=visitas-prod-db \
  --destination-database=visitas-restored-db \
  --destination-instance=visitas-instance \
  --point-in-time="2025-12-12T10:25:00Z"

# å¾©æ—§ãƒ‡ãƒ¼ã‚¿ã‚’æ¤œè¨¼å¾Œã€æœ¬ç•ªDBã¸ãƒãƒ¼ã‚¸
```

### 10.2 ç½å®³å¾©æ—§(DR)è¨ˆç”»

**ãƒªãƒ¼ã‚¸ãƒ§ãƒ³æˆ¦ç•¥:**

```
Primary: asia-northeast1 (æ±äº¬)
Secondary: asia-northeast2 (å¤§é˜ª)

Spannerãƒãƒ«ãƒãƒªãƒ¼ã‚¸ãƒ§ãƒ³æ§‹æˆ: nam-eur-asia3 (ã‚°ãƒ­ãƒ¼ãƒãƒ«ãƒ¬ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³)
```

**DRãƒ†ã‚¹ãƒˆé »åº¦:**
- ãƒ•ãƒ«ã‚¹ã‚¤ãƒƒãƒã‚ªãƒ¼ãƒãƒ¼è¨“ç·´: å¹´2å›
- éƒ¨åˆ†å¾©æ—§è¨“ç·´: å››åŠæœŸã”ã¨

### 10.3 ãƒ‡ãƒ¼ã‚¿ä¿æŒãƒãƒªã‚·ãƒ¼

| ãƒ‡ãƒ¼ã‚¿ç¨®åˆ¥ | æ³•çš„è¦ä»¶ | Visitasä¿æŒæœŸé–“ | å‰Šé™¤æ–¹å¼ |
|---|---|---|---|
| **è¨ºç™‚éŒ²(SOAP)** | 5å¹´(åŒ»å¸«æ³•24æ¡) | 10å¹´ | è«–ç†å‰Šé™¤â†’ç‰©ç†å‰Šé™¤(10å¹´å¾Œ) |
| **å‡¦æ–¹ç®‹** | 3å¹´(è–¬å‰¤å¸«æ³•28æ¡) | 5å¹´ | è«–ç†å‰Šé™¤â†’ç‰©ç†å‰Šé™¤ |
| **ç›£æŸ»ãƒ­ã‚°** | 5å¹´(ã‚¬ã‚¤ãƒ‰ãƒ©ã‚¤ãƒ³) | 10å¹´ | è‡ªå‹•ã‚¢ãƒ¼ã‚«ã‚¤ãƒ–(Coldline Storage) |
| **ãƒãƒ£ãƒƒãƒˆãƒ­ã‚°** | - | 3å¹´ | ç‰©ç†å‰Šé™¤(æ‚£è€…åŒæ„ã«åŸºã¥ã) |

---

## 11. ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹æœ€é©åŒ–æˆ¦ç•¥

### 11.1 Generated Columnsã®æˆ¦ç•¥çš„æ´»ç”¨

**é »å‡ºæ¤œç´¢ãƒ‘ã‚¿ãƒ¼ãƒ³ã®å®Ÿä½“åŒ–:**

```sql
-- è¦ä»‹è­·åº¦ã§ã®æ¤œç´¢ã‚’é«˜é€ŸåŒ–
ALTER TABLE patient_coverages
ADD COLUMN care_level_code int GENERATED ALWAYS AS (
    CASE WHEN insurance_type = 'long_term_care'
    THEN (details->'careLevelCertification'->>'levelCode')::int
    ELSE NULL END
) STORED;

CREATE INDEX idx_care_level ON patient_coverages(care_level_code)
WHERE insurance_type = 'long_term_care';

-- ç‹¬å±…æ‚£è€…ã®æŠ½å‡ºã‚’é«˜é€ŸåŒ–
ALTER TABLE patient_social_profiles
ADD COLUMN is_living_alone boolean GENERATED ALWAYS AS (
    content->'livingSituation'->>'status' = 'living_alone'
) STORED;

CREATE INDEX idx_living_alone ON patient_social_profiles(is_living_alone)
WHERE is_living_alone = true;
```

### 11.2 ã‚¯ã‚¨ãƒªãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ã®ãƒ™ã‚¹ãƒˆãƒ—ãƒ©ã‚¯ãƒ†ã‚£ã‚¹

**âŒ æ‚ªã„ä¾‹(ãƒ•ãƒ«ã‚¹ã‚­ãƒ£ãƒ³):**

```sql
-- JSONBå†…ã®ã‚­ãƒ¼ã‚’ãƒ•ã‚£ãƒ«ã‚¿æ¡ä»¶ã«ä½¿ç”¨â†’ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹æœªä½¿ç”¨
SELECT * FROM patient_coverages
WHERE details->'careLevelCertification'->>'levelCode' = '3';
```

**âœ… è‰¯ã„ä¾‹(Generated Columnåˆ©ç”¨):**

```sql
-- Generated Columnã®ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ã‚’åˆ©ç”¨
SELECT * FROM patient_coverages
WHERE care_level_code = 3;
```

### 11.3 ã‚¤ãƒ³ã‚¿ãƒ¼ãƒªãƒ¼ãƒ–ã«ã‚ˆã‚‹JOINæœ€é©åŒ–

**æ‚£è€…+ä¿é™ºæƒ…å ±+æœ€æ–°ãƒã‚¤ã‚¿ãƒ«ã‚’ä¸€æ‹¬å–å¾—:**

```sql
-- ã‚¤ãƒ³ã‚¿ãƒ¼ãƒªãƒ¼ãƒ–ãƒ†ãƒ¼ãƒ–ãƒ«ã¯ç‰©ç†çš„ã«è¿‘æ¥é…ç½®ã•ã‚Œã‚‹ãŸã‚é«˜é€Ÿ
SELECT
    p.patient_id,
    p.name,
    c.details AS insurance_details,
    o.value AS latest_vitals
FROM patients p
INNER JOIN patient_coverages c
    ON p.patient_id = c.patient_id
INNER JOIN LATERAL (
    SELECT value FROM clinical_observations
    WHERE patient_id = p.patient_id
      AND category = 'vital_signs'
    ORDER BY effective_datetime DESC
    LIMIT 1
) o ON true
WHERE p.active = true;
```

---

## 12. ç§»è¡Œãƒ»æ‹¡å¼µãƒ»ç½å®³å¾©æ—§

### 12.1 æ—¢å­˜ã‚·ã‚¹ãƒ†ãƒ ã‹ã‚‰ã®ç§»è¡Œæˆ¦ç•¥

**ãƒ•ã‚§ãƒ¼ã‚ºãƒ‰ç§»è¡Œã‚¢ãƒ—ãƒ­ãƒ¼ãƒ:**

```
Phase 1: æ‚£è€…ãƒã‚¹ã‚¿ãƒ¼ç§»è¡Œ(patients, patient_identifiers)
  â”œâ”€ ETLãƒ‘ã‚¤ãƒ—ãƒ©ã‚¤ãƒ³æ§‹ç¯‰(Cloud Data Fusion)
  â”œâ”€ ãƒ‡ãƒ¼ã‚¿ã‚¯ãƒ¬ãƒ³ã‚¸ãƒ³ã‚°(é‡è¤‡æ’é™¤ã€æ­£è¦åŒ–)
  â””â”€ ä¸¦è¡Œç¨¼åƒæœŸé–“(2é€±é–“)

Phase 2: ä¿é™ºãƒ»åŒ»ç™‚è¨˜éŒ²ç§»è¡Œ
  â”œâ”€ éå»3å¹´åˆ†ã®è¨ºç™‚éŒ²ã‚’Spannerã¸
  â””â”€ JSONBæ§‹é€ ã¸ã®å¤‰æ›(ã‚«ã‚¹ã‚¿ãƒ ã‚¹ã‚¯ãƒªãƒ—ãƒˆ)

Phase 3: æ–°æ©Ÿèƒ½(ACP, Route Optimization)ã®æ®µéšçš„å±•é–‹
  â””â”€ ãƒ‘ã‚¤ãƒ­ãƒƒãƒˆã‚¹ãƒ†ãƒ¼ã‚·ãƒ§ãƒ³(3æ‹ ç‚¹)â†’å…¨å›½å±•é–‹
```

### 12.2 ã‚¹ã‚±ãƒ¼ãƒ©ãƒ“ãƒªãƒ†ã‚£è¨­è¨ˆ

**æƒ³å®šè² è·:**

| æŒ‡æ¨™ | Year 1 | Year 3 | Year 5 |
|---|---|---|---|
| **ç™»éŒ²æ‚£è€…æ•°** | 10,000 | 100,000 | 500,000 |
| **æœˆé–“è¨ªå•è¨˜éŒ²** | 30,000 | 300,000 | 1,500,000 |
| **åŒæ™‚æ¥ç¶šã‚¹ã‚¿ãƒƒãƒ•** | 200 | 2,000 | 10,000 |
| **Spanner Nodeæ•°** | 1 | 3 | 10 |

**è‡ªå‹•ã‚¹ã‚±ãƒ¼ãƒªãƒ³ã‚°æˆ¦ç•¥:**

```yaml
# Cloud Spanner Autoscaler (Terraformä¾‹)
resource "google_spanner_instance" "main" {
  config       = "regional-asia-northeast1"
  display_name = "visitas-production"

  autoscaling {
    min_nodes = 1
    max_nodes = 10

    autoscaling_limits {
      max_processing_units = 10000
    }

    autoscaling_targets {
      high_priority_cpu_utilization_percent = 65
      storage_utilization_percent           = 75
    }
  }
}
```

### 12.3 å°†æ¥æ‹¡å¼µãƒã‚¤ãƒ³ãƒˆ

**Phase 3ä»¥é™ã®æ©Ÿèƒ½æ‹¡å¼µ:**

1. **IoT/ã‚¦ã‚§ã‚¢ãƒ©ãƒ–ãƒ«é€£æº**
   - `clinical_observations` ã«ãƒ‡ãƒã‚¤ã‚¹IDãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰è¿½åŠ 
   - Firestoreã§ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ ãƒã‚¤ã‚¿ãƒ«å—ä¿¡â†’Spannerã¸ãƒãƒƒãƒåŒæœŸ

2. **AIäºˆæ¸¬ãƒ¢ãƒ‡ãƒ«çµ±åˆ**
   - BigQueryã¸ã®ãƒ‡ãƒ¼ã‚¿ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆ(æ—¥æ¬¡)
   - Vertex AI Pipelinesã§äºˆæ¸¬ãƒ¢ãƒ‡ãƒ«è¨“ç·´
   - äºˆæ¸¬çµæœã‚’ `patient_risk_scores` ãƒ†ãƒ¼ãƒ–ãƒ«ã¸æ ¼ç´

3. **FHIR APIå…¬é–‹**
   - Cloud Healthcare APIã¨ã®çµ±åˆ
   - `patients` â†’ FHIR `Patient` å¤‰æ›ãƒ¬ã‚¤ãƒ¤ãƒ¼
   - OAuth 2.0ã«ã‚ˆã‚‹ã‚µãƒ¼ãƒ‰ãƒ‘ãƒ¼ãƒ†ã‚£ã‚¢ãƒ—ãƒªé€£æº

---

## ä»˜éŒ²A: SQL DDLå…¨é›†

**å®Œå…¨ãªãƒ†ãƒ¼ãƒ–ãƒ«å®šç¾©ã¯ä»¥ä¸‹ã®ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã«é…ç½®:**

```
/backend/migrations/
  â”œâ”€ 001_create_patients.sql
  â”œâ”€ 002_create_patient_identifiers.sql
  â”œâ”€ 003_create_patient_social_profiles.sql
  â”œâ”€ 004_create_patient_coverages.sql
  â”œâ”€ 005_create_medical_conditions.sql
  â”œâ”€ 006_create_allergy_intolerances.sql
  â”œâ”€ 007_create_clinical_observations.sql
  â”œâ”€ 008_create_care_plans.sql
  â”œâ”€ 009_create_acp_records.sql
  â”œâ”€ 010_create_medication_orders.sql
  â”œâ”€ 011_create_visit_schedules.sql
  â”œâ”€ 012_create_logistics_locations.sql
  â”œâ”€ 013_create_coordination_messages.sql
  â”œâ”€ 014_create_audit_logs.sql
  â””â”€ 015_create_views_security.sql
```

---

## ä»˜éŒ²B: JSONBæ¤œç´¢ã‚¯ã‚¨ãƒªé›†

**ã‚ˆãä½¿ã†JSONBæ¼”ç®—å­:**

```sql
-- 1. ç‰¹å®šã‚­ãƒ¼ã®å­˜åœ¨ç¢ºèª
SELECT * FROM patient_social_profiles
WHERE content ? 'financialBackground';

-- 2. ãƒã‚¹ãƒˆã—ãŸã‚­ãƒ¼ã®å€¤æ¤œç´¢
SELECT * FROM patient_social_profiles
WHERE content->'keyPersons'->0->>'role' = 'primary_caregiver';

-- 3. é…åˆ—è¦ç´ ã®æ¤œç´¢
SELECT * FROM patient_social_profiles
WHERE content->'socialHistory'->'lifestyle'->'smoking'->>'status' = 'former_smoker';

-- 4. JSONBã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã®åŒ…å«é–¢ä¿‚(@>æ¼”ç®—å­)
SELECT * FROM acp_records
WHERE directives @> '{"cpr": {"decision": "do_not_attempt"}}'::jsonb;

-- 5. é…åˆ—ã®é•·ã•å–å¾—
SELECT patient_id, jsonb_array_length(content->'keyPersons') AS key_person_count
FROM patient_social_profiles;

-- 6. JSONB â†’ ãƒ†ãƒ¼ãƒ–ãƒ«å½¢å¼ã¸ã®å±•é–‹(jsonb_to_recordset)
SELECT patient_id, kp.*
FROM patient_social_profiles,
LATERAL jsonb_to_recordset(content->'keyPersons') AS kp(
    name text,
    relationship text,
    priority int
)
WHERE kp.priority = 1;
```

---

## ä»˜éŒ²C: ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒã‚§ãƒƒã‚¯ãƒªã‚¹ãƒˆ

**æœ¬ç•ªç’°å¢ƒãƒªãƒªãƒ¼ã‚¹å‰ã®å¿…é ˆç¢ºèªé …ç›®:**

- [ ] CMEKã«ã‚ˆã‚‹Spanneræš—å·åŒ–ãŒæœ‰åŠ¹åŒ–ã•ã‚Œã¦ã„ã‚‹
- [ ] ã™ã¹ã¦ã®ãƒ†ãƒ¼ãƒ–ãƒ«ã«`is_deleted`ã‚«ãƒ©ãƒ ãŒå­˜åœ¨ã—ã€ç‰©ç†å‰Šé™¤ãŒç„¡åŠ¹åŒ–ã•ã‚Œã¦ã„ã‚‹
- [ ] ç›£æŸ»ãƒ­ã‚°ãƒ†ãƒ¼ãƒ–ãƒ«(`audit_access_logs`)ã¸ã®æ›¸ãè¾¼ã¿ãŒã™ã¹ã¦ã®CRUDæ“ä½œã§å®Ÿè¡Œã•ã‚Œã‚‹
- [ ] Firebase Authenticationã§å¤šè¦ç´ èªè¨¼(MFA)ãŒå¼·åˆ¶ã•ã‚Œã¦ã„ã‚‹
- [ ] IAMãƒ­ãƒ¼ãƒ«ãŒæœ€å°æ¨©é™åŸå‰‡ã«å¾“ã£ã¦ã„ã‚‹(é–‹ç™ºè€…ã«æœ¬ç•ªDBã¸ã®ç›´æ¥ã‚¢ã‚¯ã‚»ã‚¹æ¨©ãŒãªã„)
- [ ] Cloud ArmorãŒæœ‰åŠ¹åŒ–ã•ã‚Œã€DDoSä¿è­·ãƒ«ãƒ¼ãƒ«ãŒè¨­å®šã•ã‚Œã¦ã„ã‚‹
- [ ] Identity-Aware Proxy(IAP)ãŒWebç®¡ç†ç”»é¢ã«é©ç”¨ã•ã‚Œã¦ã„ã‚‹
- [ ] Firestore Security RulesãŒæœ¬ç•ªãƒ‡ãƒ—ãƒ­ã‚¤ã•ã‚Œã¦ã„ã‚‹
- [ ] PITRãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ãŒæ­£å¸¸ã«æ©Ÿèƒ½ã™ã‚‹ã“ã¨ãŒç¢ºèªã•ã‚Œã¦ã„ã‚‹
- [ ] ç½å®³å¾©æ—§è¨“ç·´ãŒå®Ÿæ–½ã•ã‚Œã€RTOãŒé”æˆå¯èƒ½ã§ã‚ã‚‹ã“ã¨ãŒæ¤œè¨¼ã•ã‚Œã¦ã„ã‚‹
- [ ] å€‹äººæƒ…å ±å–æ‰±åŒæ„ã®è¨˜éŒ²ãŒ`patients.consent_records`ã«æ ¼ç´ã•ã‚Œã¦ã„ã‚‹
- [ ] ãƒ‡ãƒ¼ã‚¿ä¿æŒãƒãƒªã‚·ãƒ¼ã«åŸºã¥ãè‡ªå‹•å‰Šé™¤ã‚¸ãƒ§ãƒ–ãŒç¨¼åƒã—ã¦ã„ã‚‹

---

## ã¾ã¨ã‚

æœ¬ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹è¦ä»¶å®šç¾©æ›¸ã¯ã€åœ¨å®…åŒ»ç™‚ãƒ—ãƒ©ãƒƒãƒˆãƒ•ã‚©ãƒ¼ãƒ ã€ŒVisitasã€ã«ãŠã‘ã‚‹**æ‚£è€…ãƒ‡ãƒ¼ã‚¿ã®ãƒªãƒƒãƒãªç®¡ç†ã¨ã‚»ã‚­ãƒ¥ã‚¢ãªé‹ç”¨**ã‚’å®Ÿç¾ã™ã‚‹ãŸã‚ã®åŒ…æ‹¬çš„è¨­è¨ˆæŒ‡é‡ã§ã‚ã‚‹ã€‚

**æ ¸å¿ƒçš„ãªè¨­è¨ˆåˆ¤æ–­:**

1. **SOAPä¸»å°å‹ãƒã‚¤ãƒ–ãƒªãƒƒãƒ‰ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£**: åŒ»ç™‚è¨˜éŒ²ã®æ€§è³ªã«åˆã‚ã›ã¦ã€ãƒªãƒ¬ãƒ¼ã‚·ãƒ§ãƒŠãƒ«ã¨JSONBã‚’æˆ¦ç•¥çš„ã«ä½¿ã„åˆ†ã‘
2. **å¤šå±¤é˜²å¾¡ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£**: ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ã€èªè¨¼ã€æš—å·åŒ–ã€ã‚¢ã‚¯ã‚»ã‚¹åˆ¶å¾¡ã€ç›£æŸ»ã®5å±¤ã§åŒ»ç™‚æƒ…å ±ã‚’ä¿è­·
3. **APIçµ±åˆæœ€å„ªå…ˆè¨­è¨ˆ**: Route Optimization APIã¨ã®æ·±ã„çµ±åˆã«ã‚ˆã‚Šã€ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ãŒãƒ­ã‚¸ã‚¹ãƒ†ã‚£ã‚¯ã‚¹ã‚¨ãƒ³ã‚¸ãƒ³ã¨ã—ã¦æ©Ÿèƒ½
4. **åˆ¶åº¦å¤‰æ›´ã¸ã®è€æ€§**: æ—¥æœ¬ã®è¤‡é›‘ãªä¿é™ºåˆ¶åº¦ã‚’JSONBã§ã‚«ãƒ—ã‚»ãƒ«åŒ–ã—ã€ã‚¹ã‚­ãƒ¼ãƒå¤‰æ›´ã‚³ã‚¹ãƒˆã‚’æœ€å°åŒ–
5. **ä»‹è­·è€…ã‚¦ã‚§ãƒ«ãƒ“ãƒ¼ã‚¤ãƒ³ã‚°ã®å¯è¦–åŒ–**: æ‚£è€…ã ã‘ã§ãªãä»‹è­·è€…ã®è² æ‹…ã‚‚æ§‹é€ åŒ–ãƒ‡ãƒ¼ã‚¿ã¨ã—ã¦è¨˜éŒ²ãƒ»è©•ä¾¡

ã“ã®ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£ã¯ã€å˜ãªã‚‹ãƒ‡ãƒ¼ã‚¿ä¿å­˜åŸºç›¤ã§ã¯ãªãã€**AIãŒç†è§£å¯èƒ½ãªæ§‹é€ åŒ–ã•ã‚ŒãŸåŒ»ç™‚ãƒŠãƒ©ãƒ†ã‚£ãƒ–**ã¨ã—ã¦æ©Ÿèƒ½ã—ã€Geminiã«ã‚ˆã‚‹ã‚«ãƒ«ãƒ†è‡ªå‹•ç”Ÿæˆã€æ³•çš„æ›¸é¡ã®AIä¸‹æ›¸ãä½œæˆã€äºˆæ¸¬çš„ã‚±ã‚¢ãƒ—ãƒ©ãƒ³ãƒ‹ãƒ³ã‚°ã¨ã„ã£ãŸæ¬¡ä¸–ä»£æ©Ÿèƒ½ã®åŸºç›¤ã¨ãªã‚‹ã€‚

---

**æ‰¿èª:**

| å½¹å‰² | æ°å | æ‰¿èªæ—¥ | ç½²å |
|---|---|---|---|
| ãƒ—ãƒ­ãƒ€ã‚¯ãƒˆã‚ªãƒ¼ãƒŠãƒ¼ | | | |
| ãƒ†ãƒƒã‚¯ãƒªãƒ¼ãƒ‰ | | | |
| åŒ»ç™‚ç›£ä¿® | | | |
| ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£è²¬ä»»è€… | | | |

**æ”¹è¨‚å±¥æ­´:**

| ç‰ˆ | æ—¥ä»˜ | å¤‰æ›´å†…å®¹ | å¤‰æ›´è€… |
|---|---|---|---|
| 1.0 | 2025-12-12 | åˆç‰ˆä½œæˆ | |
